<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel.html">
<link rel="import" href="./../../../../bower_components/gl-grid/gl-grid-row.html">
<link rel="import" href="./../../../../bower_components/gl-grid/gl-grid-col.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-input.html">
<link rel="import" href="./../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">

<link rel="import" href="./../../../../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="./../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="./../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-combo-box.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-textarea.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel-footer.html">
<link rel="import" href="./../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="./../../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="./../../components/validateFormBehaviors.html">
<link rel="import" href="./../../components/format-number-behavior.html">
<link rel="import" href="./../../components/g2g-logic-behavior.html">
<link rel="import" href="./../../../layout/shared-styles.html">



<dom-module id="contract-detail">
  <style include="iron-flex iron-flex-factors iron-flex-alignment shared-styles">
    * {
      font-family: 'CSChatThaiUI', sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    gl-form-dropdown-menu {
      width: 100%;
    }



    .riceName {
      margin-top: 25px;
      font-size: var(--font-size-h5);
    }
    /*paper-button.btnInTable {
      --paper-button: {
        margin-top: 0px;
        height: 32px;
      }
    }*/

    .titleName {
      margin-bottom: 10px;
    }
    /*.table-head>tr>th:nth-child(1),
    .table-head>tr>th:nth-child(3),
    .table-body>tr>td:nth-child(1),
    .table-body>tr>td:nth-child(3),
    .table-foot>tr>td:nth-child(1),
    .table-foot>tr>td:nth-child(3) {
      width: 20%;
      text-align: center;
    }

    .table-head>tr>th:nth-child(2),
    .table-body>tr>th:nth-child(2),
    .table-foot>tr>th:nth-child(2) {
      width: 60%;
    }*/

    .gl-table-default {
      margin-bottom: 20px;
    }

    .upGlComboBox {
      margin-top: -20px;
    }

    vaadin-date-picker {
      font-family: 'CSChatThaiUI', sans-serif !important;
      -webkit-font-smoothing: antialiased !important;
      color: red !important;
    }

    paper-button[disabled] {
      background: #eaeaea;
      color: #a8a8a8;
    }

    gl-form-input.number {
      --paper-input-container-input: {
        text-align: left;
      }
    }

    gl-form-input.number[disabled] {
      --paper-input-container-input: {
        text-align: left !important;
      }
    }

    iron-icon {
      height: 16px;
      width: 16px;
      margin-right: 8px;
    }

    div.main {
      /*background-color: red;*/
      height: 300px;
      overflow-y: scroll;
      /*min-width: 300px;*/
      border: solid darkblue 1px;
    }

    div.item {
      margin: 2px 5px;
    }

    div.sub-item {
      margin: 5px 50px;
      /*display: block;*/
      /*width: 100%;*/
    }

    span.namesub {
      display: inline-block;
      /*background-color: blue;*/
      width: 70%;
    }

    span.year {
      display: inline-block;
      width: 20%;
      /*background-color: red;*/
      /*display: inline;*/
      /*float: right;*/
    }

    #table-wrapper {
      position: relative;
      border: 1px solid #a8a8a8;
    }

    #table-scroll {
      height: 450px;
      overflow: auto;
      /*margin-top: 20px;*/
    }

    #table-wrapper table {
      width: 100%;
    }

    #table-wrapper table * {
      /*background: yellow;*/
      color: black;
    }

    #table-wrapper table thead th .text {
      position: absolute;
      top: -20px;
      z-index: 2;
      height: 20px;
      width: 35%;
      /*border: 1px solid red;*/
    }
  </style>
  <template>
    <gl-form-panel set-padding="10px 20px 10px 20px" set-border="1px">
      <!--<template is="dom-if" if="[[_isViewing(isViewSeleted)]]">-->
      <div class="horizontal end-justified layout">
        <paper-icon-button id="edit" class="crud" icon="create" raised on-tap="editContract" disabled="[[!commonState.btnDisabled]]"></paper-icon-button>
        <paper-tooltip for="edit" offset="0">{{localizeCommon.edit}}</paper-tooltip>
        <paper-icon-button id="delete" class="crud" icon="delete" raised on-tap="deleteContract" disabled="[[!commonState.btnDisabled]]"></paper-icon-button>
        <paper-tooltip for="delete" offset="0">{{localizeCommon.delete}}</paper-tooltip>
      </div>
      <!--</template>-->
      <gl-grid-row width="{{getWidth}}">
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,9]]">
          <gl-form-input required class="required" disabled="[[_checkArrayTrue(commonState.btnDisabled,data.contract_status)]]" error-message="{{localizeContract.error_input}}{{localizeContract.contract_name}}"
            label="{{localizeContract.contract_name}}" value="{{data.contract_name}}" placeholder="{{localizeContract.contract_name}}"></gl-form-input>
        </gl-grid-col>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]">
          <gl-form-input type="date" always-float-label class="required" required disabled="[[_checkArrayTrue(commonState.btnDisabled,data.contract_status)]]"
            label="{{localizeContract.date}}" error-message="{{localizeContract.error_input}}{{localizeContract.date}}" value="{{data.contract_date}}">
          </gl-form-input>
        </gl-grid-col>
      </gl-grid-row>
      <gl-grid-row width="{{getWidth}}">
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,9]]">[[changeString2Num(data.*,'contract_no')]]
          <gl-form-input type="number" required class="required" error-message="{{localizeContract.error_input}}{{localizeContract.contract_no}}"
            disabled="[[_checkArrayTrue(commonState.btnDisabled,data.contract_status)]]" label="{{localizeContract.contract_no}}"
            value="{{data.contract_no}}" placeholder="{{localizeContract.contract_no}}"></gl-form-input>
        </gl-grid-col>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]">
          <!--<gl-form-input type="date" always-float-label class="required" required disabled="[[_checkArrayTrue(commonState.btnDisabled,data.contract_status)]]"
            label="{{localizeContract.label_date}}" error-message="{{localizeContract.label_error_date}}" value="{{data.contract_date}}">
            </vaadin-date-picker>-->
        </gl-grid-col>
      </gl-grid-row>

      <gl-grid-row width="{{getWidth}}">
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,9]]">
          <gl-combo-box class="required" required disabled="[[_checkArrayTrue(commonState.btnDisabled,data.contract_status)]]" label="{{localizeContract.payment_type}}"
            error-message="{{localizeContract.error_input}}{{localizeContract.payment_type}}" placeholder="{{localizeContract.payment_type}}"
            items="[[payterms]]" item-label-path="payterms_Name" item-value-path="payterms_Id" value="{{data.payterm}}">
            <template>
              [[item.payterms_Name]]
            </template>
          </gl-combo-box>
        </gl-grid-col>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,3]]">[[changeString2Num(data.*,'contract_weight')]]
          <gl-form-input class="required number" required allowed-pattern="[0-9||,||.]" format-number="on" disabled="[[_checkArrayTrue(commonState.btnDisabled,data.contract_status)]]"
            error-message="{{localizeContract.error_input}}{{localizeContract.quantity}}" required label="{{localizeContract.quantity}}"
            value="{{data.contract_weight}}" placeholder="{{localizeContract.quantity}}" id="contract_weight"></gl-form-input>
        </gl-grid-col>
      </gl-grid-row>

      <gl-grid-row>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,9]]">
          <!--[[_getBuyerAddressFromData(data)]]-->
          <gl-combo-box class="required" always-float-label required id="buyer_id" label="{{localizeContract.buyer}}" placeholder="{{localizeContract.buyer}}"
            disabled="[[_checkArrayTrue(commonState.btnDisabled,data.contract_status)]]" items="{{buyerList}}" item-label-path="buyer_name"
            item-value-path="buyer_id" error-message="{{localizeContract.error_dropdown}}{{localizeContract.buyer}}" value="{{data.buyer_id}}"
            on-selected-item-changed="_getBuyerAddress">
            <template>
              [[item.buyer_name]]
            </template>
          </gl-combo-box>
        </gl-grid-col>
      </gl-grid-row>

      <gl-grid-row>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,9]]">
          <gl-form-input disabled label="{{localizeContract.fax}}" value="{{dataShow.buyer_fax}}" placeholder="{{localizeContract.fax}}"></gl-form-input>
        </gl-grid-col>
      </gl-grid-row>
      <gl-grid-row>

        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,6]]">
          <gl-form-textarea rows="2" disabled label="{{localizeContract.buyer_address}}" placeholder="{{localizeContract.buyer_address}}"
            value="{{dataShow.buyerAddress}}"></gl-form-textarea>
        </gl-grid-col>
      </gl-grid-row>

      <gl-grid-row>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,12]]">

          <div class="titleName">{{localizeContract.label_list_rice}}</div>
          <!--<table class="gl-table-default">
            <thead class="table-head">
              <tr>
                <th>{{localizeContract.label_order}}</th>
                <th>{{localizeContract.label_rice_type}}</th>
                <th>
                  <template is="dom-if" if="[[!_isViewing(commonState.btnDisabled)]]">
                    {{localizeContract.label_action}}
                  </template>
                </th>
              </tr>
            </thead>
            <template is="dom-if" if="[[!_isViewing(commonState.btnDisabled)]]">
              <tfoot class="table-foot">
                <tr>
                  <td></td>
                  <td></td>
                  <td>
                    <paper-button hidden="[[commonState.btnDisabled]]" raised id="[[index]]" on-tap="addTypeRice" class="btnInTable gl-btn-primary">
                      <iron-icon icon="add"></iron-icon>{{localizeContract.btn_add}}</paper-button>
                  </td>
                </tr>
              </tfoot>
            </template>
            <tbody class="table-body">
              <template is="dom-repeat" items="[[data.contract_type_rice]]">
                <tr>
                  <td>
                    [[_ObcountIndex(index)]]
                  </td>
                  <td>
                    <div class="upGlComboBox">
                      <gl-combo-box id="rice-[[index]]" class="required" required disabled="[[commonState.btnDisabled]]" error-message="{{localizeContract.label_error_rice_type}}"
                        placeholder="{{localizeContract.label_rice_type}}" name="type_rice_name" item-label-path="type_rice_name_th"
                        item-value-path="type_rice_id" value="{{item.type_rice_id}}" on-value-changed="_typeRiceContract">
                        <template>
                          [[item.type_rice_name_th]]
                        </template>
                      </gl-combo-box>
                    </div>
                  </td>
                  <td>
                    <template is="dom-if" if="[[!_isViewing(data.isInputDisabled)]]">
                      <paper-button hidden="[[commonState.btnDisabled]]" raised id="[[index]]" on-tap="deleteTypeRice" class="btnInTable gl-btn-danger"
                        title="ลบชนิดข้าว">
                        <iron-icon icon="remove"></iron-icon>{{localizeContract.btn_delete}}</paper-button>
                    </template>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>-->
          <span class="namesub">
            <gl-combo-box id="hamonizeCode" disabled="[[commonState.btnDisabled]]" label="{{localizeContract.rice_type}}"
             placeholder="{{localizeContract.rice_type}}" items="[[hamonizeYear.hamonize]]"
            item-label-path="label" item-value-path="id" on-value-changed="searchHamonizeInCode">
              <template>
                [[item.label]]
              </template>
          </gl-combo-box>
                      </span>
          <span class="year">
                        <!--ปีที่ตั้งรหัส Hamonize -->
            <gl-combo-box id="hamonizeYear" disabled="[[commonState.btnDisabled]]" label="{{localizeContract.year}}"
           placeholder="{{localizeContract.year}}" items="[[hamonizeYear.year]]"
            item-label-path="label" item-value-path="label" on-value-changed="searchHamonizeInYear">
              <template>
                [[item.label]]
              </template>
            </gl-combo-box>
                      </span>
          <!--<div class="main">

            <template is="dom-repeat" items={{hamonizeList}} index-as="indexroot">
              <div class="item" hidden="{{item.hiddend}}">

                <iron-icon icon="chevron-right" index="[[indexroot]]" on-tap="toggle"></iron-icon>

                <paper-checkbox checked="{{item.check}}" id="{{indexroot}}" on-tap="getCheckChild" disabled="[[commonState.btnDisabled]]">
               
                  [[item.name_th]]
                </paper-checkbox>
                <iron-collapse id="collapse-[[indexroot]]" opened="true">
                  <div>
                    <template is="dom-repeat" items={{item.sub}} as="subChild">
                      <div class="sub-item" hidden="{{subChild.hiddend}}">
                        <paper-checkbox id="{{indexroot}}" checked="{{subChild.check}}" on-tap="getSelect" disabled="[[commonState.btnDisabled]]">
                      
                        </paper-checkbox>
                        <span class="namesub">
                        [[subChild.hamonize_th2]]
                      </span>
                        <span class="year">
                        [[subChild.hamonize_year]]
                      </span>
                      </div>
                    </template>
                  </div>
                </iron-collapse>
              </div>
              <br>
            </template>
          </div>-->
          <div id="table-wrapper">
            <div id="table-scroll">
              <table class="gl-table-default">
                <thead class="table-head">
                  <tr  >
                    <th style="width:30px"></th>
                    <th style="width:30px"></th>
                    <th>ชื่อกลุ่มข้าว</th>
                    <th>ชื่อข้าว</th>
                    <th>รหัส Hamonize</th>
                    <th>ปี</th>
                  </tr>
                </thead>
                <tbody class="table-body">
                  <template is="dom-repeat" items={{hamonizeList}} index-as="indexroot">
                    <tr hidden="{{item.hiddend}}">
                      <td>
                        <paper-checkbox checked="{{item.check}}" id="{{indexroot}}" on-tap="getCheckChild" disabled="[[commonState.btnDisabled]]">
                      </td>
                      <td>-</td>
                      <td>[[item.name_th]]</td>
                      <td>-</td>
                      <td>-</td>
                      <td>-</td>
                    </tr>
                    <template is="dom-repeat" items={{item.sub}} as="subChild">
                      <tr hidden="{{subChild.hiddend}}">
                        <td></td>
                        <td>
                          <paper-checkbox id="{{indexroot}}" checked="{{subChild.check}}" on-tap="getSelect" disabled="[[commonState.btnDisabled]]">
                        </td>
                        <td></td>
                        <td>[[subChild.hamonize_th2]]</td>
                        <td>[[subChild.hamonize_code]]</td>
                        <td>[[subChild.hamonize_year]]</td>
                      </tr>
                    </template>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </gl-grid-col>
      </gl-grid-row>

      <gl-grid-row>
        <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,6]]">
          <gl-form-textarea disabled="[[_checkArrayTrue(commonState.btnDisabled,data.contract_status)]]" rows="2" label="{{localizeContract.more_detail}}"
            placeholder="{{localizeContract.more_detail}}" value="{{data.contract_desc}}" name="contract_desc"></gl-form-textarea>
        </gl-grid-col>
      </gl-grid-row>
      <gl-form-panel-footer label="" set-padding="10px">
        <div class="horizontal end-justified layout">

          <template is="dom-if" if="[[commonState.isInsert]]">
            <paper-button class="gl-btn-primary" on-tap="insertContract" raised>{{localizeCommon.add}}</paper-button>
          </template>
          <template is="dom-if" if="[[!commonState.isInsert]]">
            <paper-button class="gl-btn-default" on-tap="calcelContract" raised hidden="[[commonState.btnDisabled]]">{{localizeCommon.cancel}}</paper-button>
            <paper-button class="gl-btn-success" on-tap="saveContract" raised hidden="[[commonState.btnDisabled]]">{{localizeCommon.save}}</paper-button>
          </template>
          <template is="dom-if" if="[[commonState.btnDisabled]]">
            <paper-button class="gl-btn-info" raised on-tap="confirmDrawer" hidden="[[data.contract_status]]">{{localizeCommon.confirm}}</paper-button>
          </template>
        </div>
      </gl-form-panel-footer>
    </gl-form-panel>
  </template>
  <script>
    Polymer({
      is: "contract-detail",
      behaviors: [
        ReduxBehavior, FormatNumberBehavior, nylonBehavior, g2gLogicBehavior, ValidateFormBehavior
      ],
      properties: {
        localizeContract: {
          statePath: 'i18n.contract'
        },
        localizeCommon: {
          statePath: 'i18n.common'
        },

        commonState: {
          statePath: 'commonState.setState'
        },
        data: {
          statePath: 'contract.contractDetail',
          observer: 'checkContract'
        },
        dataShow: {
          type: Object,
          value: {}
        },
        buyerList: {
          statePath: 'commonG2g.buyerList',
          // observer:'get'
        },
        hamonizeList: {
          statePath: 'commonG2g.hamonizeList',
          // observer: 'get'
        },
        hamonizeYear: {
          statePath: 'commonG2g.hamonizeYear',
          // observer: 'get'
        },
        // dataForSelect: {
        //   type: Object,
        // },
        // data: {
        //   type: Object,
        //   value: { contract_weight: 0, contract_type_rice: [{}] }
        // },
        // dataForUse: {
        //   type: Object,
        // },
        payterms: {
          type: Object,
          value: [
            { payterms_Name: 'L/C', payterms_Id: 'L/C' },
            { payterms_Name: 'T/T', payterms_Id: 'T/T' },
            { payterms_Name: 'D/P', payterms_Id: 'D/P' },
            { payterms_Name: 'D/A', payterms_Id: 'D/A' }
          ]
        }
      },
      get(data) {
        // console.log(data);
      },
      observers: [
        '_checkHamonize(data,hamonizeList)'
      ],
      checkContract: function (data) {
        if (data.id === undefined) {
          this.set('dataShow.buyer_fax', '')
          this.set('dataShow.buyerAddress', '')
          // console.log(211111);
          this._checkHamonize(this.data, this.hamonizeList, false)
        }
        // console.log(data.id);
      },
      _checkHamonize: function (data, hamonizeList, status = true) {
        try {
          let contract_hamonize = data.contract_hamonize
          // let hamonize = hamonizeList
          if (data.id === undefined)
            status = false
          for (var index = 0; index < contract_hamonize.length; index++) {
            for (var index2 = 0; index2 < hamonizeList.length; index2++) {
              for (var index3 = 0; index3 < hamonizeList[index2].sub.length; index3++) {
                if (contract_hamonize[index].hamonize_id === hamonizeList[index2].sub[index3].sub_id) {
                  // console.log(status);
                  this.set('hamonizeList.' + index2 + '.sub.' + index3 + '.check', status)
                  // console.log(contract_hamonize[index].hamonize_id === hamonizeList[index2].sub[index3].sub_id);
                  break
                }
              }
            }
          }
        } catch (e) {
        }
      },
      getCheckChild(e) {
        let item = e.model.__data__.item
        let indexRoot = e.currentTarget.id
        let checkHost = e.currentTarget.checked
        this.hamonizeList[indexRoot].sub.map((item, index) => {
          this.set('hamonizeList.' + indexRoot + '.sub.' + index + '.check', checkHost)
        })
      },
      getSelect(e) {
        let indexRoot = e.currentTarget.id
        let checkHost = e.currentTarget.checked
        let checkFalse = this.hamonizeList[indexRoot].sub.find((item) => item.check !== true)
        this.set('hamonizeList.' + indexRoot + '.check', checkFalse === undefined)
      },
      editContract() {
        this.dispatchAction('SET_STATE', {
          isInsert: false,
          btnDisabled: false,
          hiddend: true
        })
      },
      searchHamonizeInYear: function (e) {
        try {
          let newHamonize = []
          let seletedYear = e.detail.value
          for (var index = 0; index < this.hamonizeList.length; index++) {
            for (var index2 = 0; index2 < this.hamonizeList[index].sub.length; index2++) {
              if ((String(this.hamonizeList[index].sub[index2].hamonize_year) === e.detail.value) ||
                (e.detail.value === '' || e.detail.value === undefined)) {
                this.set('hamonizeList.' + index + '.sub.' + index2 + '.hiddend', false)
              } else {
                this.set('hamonizeList.' + index + '.sub.' + index2 + '.hiddend', true)
              }
            }
            let checkkFalse = this.hamonizeList[index].sub.find((item) => item.hiddend === false)
            if (checkkFalse === undefined) {
              this.set('hamonizeList.' + index + '.hiddend', true)
            } else {
              this.set('hamonizeList.' + index + '.hiddend', false)
            }
          }
          this.$$('#hamonizeCode').value = ''


        } catch (e) {

        }

      },
      searchHamonizeInCode: function (e) {
        try {
          let newHamonize = []
          let seletedCode = e.detail.value
          // console.log(seletedCode);
          for (var index = 0; index < this.hamonizeList.length; index++) {
            for (var index2 = 0; index2 < this.hamonizeList[index].sub.length; index2++) {
              if ((String(this.hamonizeList[index].sub[index2].sub_id) === seletedCode) ||
                (seletedCode === '' || seletedCode === undefined)) {
                this.set('hamonizeList.' + index + '.sub.' + index2 + '.hiddend', false)
              } else {
                this.set('hamonizeList.' + index + '.sub.' + index2 + '.hiddend', true)
              }
            }
            let checkkFalse = this.hamonizeList[index].sub.find((item) => item.hiddend === false)
            if (checkkFalse === undefined) {
              this.set('hamonizeList.' + index + '.hiddend', true)
            } else {
              this.set('hamonizeList.' + index + '.hiddend', false)
            }
          }
          this.$$('#hamonizeYear').value = ''
        } catch (e) {

        }

      },
      toggle: function (e) {
        let index = e.currentTarget.index
        // console.log(collapse-);
        this.$$('#collapse-' + index).toggle()
      },
      _getBuyerAddress: function (e) {
        if (e.detail.value) {
          // console.log(e.detail.value);
          let data = e.detail.value
          let buyer = {
            buyer: {
              buyer_address: data.buyer_address,
              buyer_email: data.buyer_email,
              buyer_fax: data.buyer_fax,
              buyer_masks: data.buyer_masks,
              buyer_name: data.buyer_name,
              buyer_tel: data.buyer_tel,
              country_id: data.country_id
            },
            country: {
              continent_id: data.continent_id,
              country_code2: data.country_code2,
              country_code3: data.country_code3,
              country_fullname_en: data.country_fullname_en,
              country_fullname_th: data.country_fullname_th,
              country_name_en: data.country_name_en,
              country_name_th: data.country_name_th
            },
          }
          this.set('dataShow.obj', buyer)
          this.set('dataShow.buyer_fax', e.detail.value.buyer_fax)
          this.set('dataShow.buyerAddress', e.detail.value.buyer_address)
        }
      },
      _getHamonize: function (hamonizeList) {
        let hamonizeArr = []
        hamonizeList = hamonizeList || this.hamonizeList
        for (var index2 = 0; index2 < hamonizeList.length; index2++) {
          for (var index3 = 0; index3 < hamonizeList[index2].sub.length; index3++) {
            if (hamonizeList[index2].sub[index3].check === true) {
              let data = {
                digits: hamonizeList[index2].sub[index3].digits,
                hamonize_code: hamonizeList[index2].sub[index3].hamonize_code,
                hamonize_en: hamonizeList[index2].sub[index3].hamonize_en,
                hamonize_en2: hamonizeList[index2].sub[index3].hamonize_en2,
                hamonize_th: hamonizeList[index2].sub[index3].hamonize_th,
                hamonize_th2: hamonizeList[index2].sub[index3].hamonize_th2,
                hamonize_year: hamonizeList[index2].sub[index3].hamonize_year
              }
              hamonizeArr.push({
                hamonize_id: hamonizeList[index2].sub[index3].sub_id,
                hamonize: data
              })
            }
          }
        }
        return hamonizeArr
      },
      _resiveDataContract: function () {
        return new Promise((res, rej) => {
          let dataResive = this.data
          dataResive.contract_hamonize = this._getHamonize()
          dataResive.buyer = this.dataShow.obj.buyer
          dataResive.country = this.dataShow.obj.country
          dataResive.contract_no = Number(dataResive.contract_no)
          dataResive.country_id = this.dataShow.obj.buyer.country_id
          dataResive.contract_date = dataResive.contract_date + 'T00:00:00+07:00'
          delete dataResive.date_updated
          delete dataResive.date_created
          res(dataResive)
        })
      },
      _resiveForm: function () {
        return new Promise((res, rej) => {
          if (this.validateForm('.required')) {
            this._resiveDataContract().then((data) => {
              res(data)
            })
          } else {
            this.fire('toast', {
              status: 'connectError', text: 'กรุณากรอกข้อมูลให้ครบทุกช่อง', //คำสั่งสำหรับเปิด toast error
              callback: function () {
                rej('error')
              }
            })
          }
        })
      },
      insertContract: function () {
        // console.log(this.validateForm('.required'));
        this._resiveForm()
          .then((res) => {
            this.fire('toast', { status: 'load' }); //คำสั่งสำหรับเปิด toast load
            res.contract_status = false
            this.dispatchAction('POST_CONTRACT', res)
              .then((response) => {
                // console.log(response);
                if (response.data.inserted !== undefined && response.data.inserted.length !== 0) {
                  this.dispatchAction('GET_CONTRACT_OF_BUYER', res.buyer_id);
                  this.fire('toast', {
                    status: 'success', text: 'บันทึกสำเร็จ',  // คำสั่งสำหรับเปิด toast success
                    callback: () => {
                      this.queryFrom('.required').map((el) => { el.reset(); });
                      this.fire('close-drawer')
                    }
                  })
                } else {
                  // console.log(1111);
                  this.fire('toast', {
                    status: 'connectError', text: response.data, //คำสั่งสำหรับเปิด toast error
                    callback: () => {
                    }
                  })
                }


              })
          })
          .catch((error) => {
            console.log(error);
          });

      },

      saveContract: function () {
        this.fire('toast', {
          status: 'openDialog',
          text: 'ต้องการแก้ข้อมูลใช่หรือไม่ ?',
          confirmed: (result) => {
            if (result == true) {
              this._resiveForm()
                .then((res) => {
                  // console.log(res);
                  // this.fire('toast', { status: 'load' }); //คำสั่งสำหรับเปิด toast load
                  this.dispatchAction('PUT_CONTRACT', res)
                    .then((response) => {
                      // console.log(response);
                      if (response.data.replaced !== undefined && response.data.replaced.length !== 0) {
                        this.dispatchAction('GET_CONTRACT_OF_BUYER', res.buyer_id);
                        this.dispatchAction('GET_CONTRACT', res.id)
                        this.queryFrom('.required').map((el) => { el.reset(); });
                        this.dispatchAction('SET_STATE', {
                          isInsert: false,
                          btnDisabled: true,
                          hiddend: true
                        })
                        this.fire('toast', {
                          status: 'success', text: 'บันทึกสำเร็จ',  // คำสั่งสำหรับเปิด toast success
                          callback: () => {
                          }
                        })
                      } else {
                        // console.log(1111);
                        this.fire('toast', {
                          status: 'connectError', text: response.data, //คำสั่งสำหรับเปิด toast error
                          callback: () => {
                          }
                        })
                      }

                    })
                })
                .catch((error) => {
                  console.log(error);
                });
            }
          }
        })
      },
      deleteContract: function () {
        this.fire('toast', {
          status: 'openDialog',
          text: 'ต้องการลบข้อมูลใช่หรือไม่ ?',
          confirmed: (result) => {
            if (result == true) {
              this._resiveForm()
                .then((res) => {
                  // console.log(res);
                  this.fire('toast', { status: 'load' }); //คำสั่งสำหรับเปิด toast load
                  this.dispatchAction('DELETE_CONTRACT', res.id)
                    .then((response) => {
                      if (response.data.deleted !== undefined && response.data.deleted.length !== 0) {
                        this.dispatchAction('GET_CONTRACT_OF_BUYER', res.buyer_id);
                        this.fire('toast', {
                          status: 'success', text: 'ลบสำเร็จ',  // คำสั่งสำหรับเปิด toast success
                          callback: () => {
                          }
                        })
                        this.fire('close-drawer')
                      } else {
                        // console.log(1111);
                        this.fire('toast', {
                          status: 'connectError', text: response.data, //คำสั่งสำหรับเปิด toast error
                          callback: () => {
                          }
                        })
                      }

                    })
                })
                .catch((error) => {
                  console.log(error);
                });
            }
          }
        })
      },
      calcelContract: function () {
        this.fire('toast', {
          status: 'openDialog',
          text: 'ต้องการยกเลิกแก้ข้อมูลใช่หรือไม่ ?',
          confirmed: (result) => {
            if (result == true) {
              this._resiveForm()
                .then((res) => {
                  this.dispatchAction('GET_CONTRACT', res.id)
                  this.dispatchAction('SET_STATE', {
                    isInsert: false,
                    btnDisabled: true,
                    hiddend: true
                  })
                  this.queryFrom('.required').map((el) => { el.reset(); });
                })
            }
          }
        })
      },
      confirmDrawer: function () {
        this.fire('toast', {
          status: 'openDialog',
          text: 'ต้องการยืนยันสัญญาใช่หรือไม่ ?',
          confirmed: (result) => {
            if (result == true) {
              this._resiveForm()
                .then((res) => {
                  res.contract_status = true
                  // console.log(data);
                  this.fire('toast', { status: 'load' }); //คำสั่งสำหรับเปิด toast load
                  this.dispatchAction('PUT_CONTRACT', res)
                    .then((response) => {
                      if (response.data.replaced !== undefined && response.data.replaced.length !== 0) {
                        this.dispatchAction('GET_CONTRACT_OF_BUYER', res.buyer_id);
                        this.dispatchAction('GET_CONTRACT', res.id)
                        this.queryFrom('.required').map((el) => { el.reset(); });
                        this.dispatchAction('SET_STATE', {
                          isInsert: false,
                          btnDisabled: true,
                          hiddend: true
                        })
                        this.fire('toast', {
                          status: 'success', text: 'บันทึกสำเร็จ',  // คำสั่งสำหรับเปิด toast success
                          callback: () => {
                          }
                        })
                      } else {
                        // console.log(1111);
                        this.fire('toast', {
                          status: 'connectError', text: response.data, //คำสั่งสำหรับเปิด toast error
                          callback: () => {
                          }
                        })
                      }
                    })
                })
                .catch((error) => {
                  console.log(error);
                });
            }
          }
        })
      }


    });
  </script>
</dom-module>