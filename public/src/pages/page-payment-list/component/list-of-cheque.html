<link rel="import" href="./../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="./../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="./../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="./../../components/g2g-logic-behavior.html">
<link rel="import" href="./../../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="./../../components/icon-set-g2g.html">
<link rel="import" href="./../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="./../../../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="./../../../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="./../../../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="./../../components/format-number-behavior.html">
<link rel="import" href="./../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="./../../../layout/shared-styles.html">
<link rel="import" href="./../../components/g2g-logic-behavior.html">

<link rel="import" href="../../../redux-behavior.html">

<dom-module id="list-of-cheque">
  <style include="iron-flex iron-flex-factors iron-flex-alignment shared-styles">
     :host {
      display: block;
    }

    * {
      font-family: 'CSChatThaiUI', sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    .labelSearch {
      font-size: var(--font-size-h4);
      margin: 10px 10px 10px 10px;
    }

    .table-body>tr>td {
      cursor: pointer;
    }

    .title {
      margin: 16px;
      text-align: left;
      font-size: var(--font-size-h4);
    }

    table.gl-table-default {
      width: 98%;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }

    table.gl-table-default>thead.table-head>tr>th,
    table.gl-table-default>tbody.table-body>tr>td {
      text-align: center;
    }

    table.gl-table-default>thead.table-head>tr>th:nth-child(1) {
      width: 10%;
    }

    table.gl-table-default>tbody.table-body>tr>td:not(:first-child) {
      /*text-align: right;*/
    }

    main {
      padding: 5px;
      margin: 0 auto;
    }

    section {
      display: none;
      border-top: 1px solid #ddd;
    }

    input {
      display: none;
    }

    label {
      display: inline-block;
      margin: 0 0 -1px;
      padding: 15px 25px;
      font-weight: 600;
      text-align: center;
      color: #bbb;
      border: 1px solid transparent;
      background: #D5D8DC;
    }

    label:before {
      font-family: fontawesome;
      font-weight: normal;
      margin-right: 10px;
    }

    label:hover {
      color: #888;
      cursor: pointer;
    }

    input:checked+label {
      color: #555;
      border: 1px solid #ddd;
      border-top: 3px solid orange;
      border-bottom: 1px solid #fff;
      background: #fff;
    }

    #tab1:checked~#content1,
    #tab2:checked~#content2 {
      display: block;
    }

    .container {
      display: inline-block;
      margin-left: 30px;
      margin-right: 30px;
    }
    /* Need to position the badge to look like a text superscript */

    .container>paper-badge {
      --paper-badge-margin-left: 20px;
      --paper-badge-margin-bottom: 0px;
    }

    paper-fab#fabCancel {
      right: 90px;
      /*--paper-fab-iron-icon: {
        color: black
      };*/
      /*--paper-fab-background: #fff*/
      --paper-fab-background: var(--gl-danger-color);
      /*--paper-fab-background: #fff;*/
    }

    paper-fab#fabPay {
      right: 20px;
      --paper-fab-background: var(--gl-primary-color);
      /*--paper-fab-background: #fff;*/
    }
  </style>
  <template>

    <main>
      <input id="tab1" type="radio" name="tabs" checked>
      <label for="tab1">
         <div class="container" tabindex="0">
                <span>1. {{localize.send_director}}</span>
                <paper-badge label="{{chequeFasleCount}}" style="left: 144.813px; top: 28px;"></paper-badge>
         </div>
      </label>

      <input id="tab2" type="radio" name="tabs">
      <label for="tab2">
         <div class="container" tabindex="0">
                <span>2. {{localize.wait_director}}</span>
                <paper-badge label="{{chequeTrue.length}}" style="left: 375.234px; top: 28px;"></paper-badge>
          </div>
        </label>

      <section id="content1">
        <div class="flex searchInput horizontal center-justified layout">
          <div class="flex title">{{localize.name_of_contract}} : [[contractId.contract_name]]</div>
          <div class="flex horizontal end-justified layout">
            <div class="labelSearch">{{localize.fee_no}}.</div>{{_searchInArray(searchInput)}}
            <paper-input label=" " no-label-float value="{{searchInput}}"></paper-input>
            <paper-icon-button icon="search"></paper-icon-button>
            </paper-input>
          </div>
        </div>
        [[checkSelect(chequeFasle.*)]]
        <div class="horizontal center-justified layout">
          <table class="gl-table-default">
            <thead class="table-head">
              <tr>
                <th>
                  <paper-checkbox on-tap="_selectDataAll" checked="{{selectDataAll}}"></paper-checkbox>{{localize.select}}</th>
                <th>{{localize.period_no}}</th>
                <th>{{localize.order_no}}</th>
                <th>{{localize.total_company}}</th>
              </tr>
            </thead>
            <tbody class="table-body">
              <template is="dom-repeat" items="{{chequeFasle}}">
                <tr level="primary" style="{{checkStatus(item.status)}}" hidden="{{item.hidden}}" data="{{item}}" on-tap="getDetailCheque">
                  <td data="[[item]]">
                    <paper-checkbox data="{{item}}" checked="{{item.check}}" disabled="{{item.status}}"></paper-checkbox>
                  </td>
                  <td data="[[item]]">[[item.cl_no]]</td>
                  <td data="[[item]]">[[item.fee_no]]</td>
                  <td data="[[item]]">[[item.cheque_count]]/[[item.cheque_all]]</td>
                </tr>
              </template>
              <template is="dom-if" if="[[_isShow(chequeFasle,chequeFasle.*)]]">
                <tr>
                  <td colspan="4" style="text-align:center"> {{localize.no_data}}</td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div class="btnFab" hidden="{{fabHidden}}">
          <paper-fab icon="av:playlist-add-check" title="{{localize.send_cheque}}" id="addContract" on-tap="getChequeDetail"></paper-fab>
          <paper-tooltip for="addContract" offset="0">{{localize.send_cheque}}</paper-tooltip>
        </div>
      </section>

      <section id="content2">
        <div class="flex searchInput horizontal center-justified layout">
          <div class="flex title">{{localize.name_of_contract}} : [[contractId.contract_name]]</div>
          <div class="flex horizontal end-justified layout">
            <div class="labelSearch">เลขที่เช็ค.</div>{{_searchInChequeTrue(searchInput)}}
            <paper-input label=" " no-label-float value="{{searchInput}}"></paper-input>
            <paper-icon-button icon="search"></paper-icon-button>
            </paper-input>
          </div>
        </div>
        [[checkSelectListTrue(chequeTrue.*)]]
        <div class="horizontal center-justified layout">
          <table class="gl-table-default">
            <thead class="table-head">
              <tr>
                <th>
                  <paper-checkbox on-tap="_selectDataAll" checked="{{selectDataAll}}"></paper-checkbox>{{localize.select}}</th>
                <th>เลขที่เช็ค</th>
                <th>วันที่นำส่ง</th>
              </tr>
            </thead>
            <tbody class="table-body">
              <template is="dom-repeat" items="{{chequeTrue}}">
                <tr level="primary" hidden="{{item.hidden}}">
                  <td data="[[item]]">
                    <paper-checkbox data="{{item}}" checked="{{item.check}}"></paper-checkbox>
                  </td>
                  <td data="[[item]]">[[item.pay_no]]</td>
                  <td data="[[item]]">[[item.deliver_date]]</td>
                </tr>
              </template>
              <template is="dom-if" if="[[_isShow(chequeTrue,chequeTrue.*)]]">
                <tr>
                  <td colspan="4" style="text-align:center"> {{localize.no_data}}</td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <!--<div class="btnMoney">
      <paper-button class="gl-btn-success" raised on-tap="getChequeDetail">กด (ยัง)</paper-button>
    </div>-->
        <div class="btnFab" hidden="{{fabHiddenTrue}}">
          <paper-fab id="fabCancel" icon="clear" title="{{localize.cancel}}" on-tap="getChequeReject"></paper-fab>
          <paper-tooltip for="fabCancel" offset="0">{{localize.cancel}}</paper-tooltip>
          <paper-fab id="fabPay" icon="fa:pencil" title="{{localize.submit}}" on-tap="getChequeApprove"></paper-fab>
          <paper-tooltip for="fabPay" offset="0">{{localize.submit}}</paper-tooltip>
        </div>
      </section>
    </main>
    <paper-dialog id="payDate" entry-animation="scale-up-animation" exit-animation="fade-out-animation" modal>
      <h2>{{localize.pay_date}}</h2>
      <gl-form-input type="date" placeholder="{{localize.pay_date}}" class="required" required no-label-float value="{{pay_date}}"></gl-form-input>
      <div class="buttons">
        <paper-button dialog-dismiss raised class="gl-btn-default">{{localize.cancel}}</paper-button>
        <paper-button autofocus class="gl-btn-success" raised on-tap="approveCheck">{{localize.submit}}</paper-button>
      </div>
    </paper-dialog>

  </template>
  <script>
    Polymer({
      is: "list-of-cheque",
      behaviors: [ReduxBehavior, FormatNumberBehavior, g2gLogicBehavior],
      properties: {
        localize: {
          statePath: 'i18n.cheque'
        },
        fabHidden: {
          type: Boolean,
          value: true
        },
        pay_date: {
          type: String,
          value: function () {
            return new Date().toISOString().split('T')[0]
          }
        },
        chequeFasle: {
          statePath: 'cheque.cheque_list_fasle',
          value: [],
          observer: 'countChequeFasle'
        },
        chequeFasleCount: {
          type: Number,
          value: 0
        },
        chequeTrue: {
          statePath: 'cheque.cheque_list_true',
          value: []
        },
        contractId: {
          statePath: 'commonState.contractId',
          // observer: 'get'
        },
      },
      // observers: [
      //   'initDatabl(chequeFasle)',
      // ],
      countChequeFasle: function (data) {
        let count = data.reduce((pre, cur) => {
          return pre + cur.cheque_count
        }, 0)
        this.set('chequeFasleCount', count)
        // console.log(count);
      },
      // initDatabl: function (data) {
      //   // console.log(data);
      //   this.newData = this.g2gClone(data);
      //   // console.log('clone new==>',this.newData);
      //   // console.log('org==>',this.data);
      // },
      _searchInArray: function (searchInput) {
        // console.log(searchInput == '');
        // if (searchInput != '') {
        //   let arr = [];
        //   this.data.map((el) => {
        //     if (String(el.fee_no).search(searchInput) > -1) {
        //       arr.push(el);
        //     }
        //   });
        //   this.newData = arr;
        // } else {
        //   this.initDatabl(this.data);
        // }
        // console.log(searchInput);
        for (var index = 0; index < this.chequeFasle.length; index++) {
            if (String(this.chequeFasle[index].fee_no).search(String(searchInput)) > -1 ) {

                this.set('chequeFasle.'+index+'.hidden',false)
            }else {
                this.set('chequeFasle.'+index+'.hidden',true)
            }
          
        }
      },
      _searchInChequeTrue(search){
        
        for (var index = 0; index < this.chequeTrue.length; index++) {
            if (String(this.chequeTrue[index].pay_no).search(String(search)) > -1 ) {

                this.set('chequeTrue.'+index+'.hidden',false)
            }else {
                this.set('chequeTrue.'+index+'.hidden',true)
            }
          
        }
        // console.log(search);
      },
      _selectDataAll: function (val) {
        try {
          this.chequeFasle.map((item, index) => {
            if (item.status === false)
              this.set('chequeFasle.' + index + '.check', this.selectDataAll);
          });
        } catch (error) {

        }
      },
      checkStatus: function (status) {
        if (status) return 'background-color: #F1F1F1;'
        return ''
        // console.log(status)
      },
      checkSelect: function (data) {
        let check = this.chequeFasle.find((item) => item.check === true)
        if (check !== undefined)
          return this.set('fabHidden', false)
        return this.set('fabHidden', true)
      },
      checkSelectListTrue: function (data) {
        let check = this.chequeTrue.find((item) => item.check === true)
        if (check !== undefined)
          return this.set('fabHiddenTrue', false)
        return this.set('fabHiddenTrue', true)
      },
      getChequeDetail: function (e) {
        // console.log(e.currentTarget.data);
        let getData = this.chequeFasle.filter((item) => item.check === true)
        let fee_id = []
        getData.map((item) => {
          fee_id.push(item.fee_id)
        })//fee_id

        let arr = fee_id.reduce((pre, curr) => pre.concat(curr), [])
        // console.log(arr)
        this.dispatchAction('SET_CHEQUE_DETAIL_LIST', arr)
        this.fire('get-cheque-detail', { detail: arr });

      },
      // getCheque: function (e) {
      //   // console.log(e.currentTarget.data);
      //   window.open(window._config.reportServer+'/api/payment/report10/' + e.currentTarget.data.fee_id, '1');
      // },
      getDetailCheque(e) {
        let data = e.currentTarget.data
        let fee_id = data.fee_id
        if (data.status) {
          let arr = fee_id
          this.dispatchAction('SET_CHEQUE_DETAIL_LIST', arr)
          this.fire('get-cheque-detail', { detail: arr });
        }

      },
      getChequeReject: function () {
        // console.log(1111);
        let getData = this.chequeTrue.filter((item) => item.check === true)
        let newArr = []
        getData.map((item) => {
          newArr.push({ deliver_date: item.deliver_date + 'T00:00:00+07:00' })
        })
        this.fire('toast', {
          status: 'openDialog',
          text: 'ต้องการยกเลิกใช่หรือไม่ ?',
          confirmed: (result) => {
            if (result == true) {
              this.dispatchAction('PUT_REJECT_CHEQUE_LIST', newArr)
                .then((response) => {
                  if (response.data.replaced !== undefined && response.data.replaced.length !== 0) {
                    this.fire('toast', {
                      status: 'success', text: 'ยกเลิกสำเร็จ',  // คำสั่งสำหรับเปิด toast success
                      callback: () => {
                      }
                    })
                    let chequeTrue = { id: this.contractId.contract_id, status: true }
                    let chequeFasle = { id: this.contractId.contract_id, status: false }
                    this.dispatchAction('GET_CHEQUE_LIST', this.genUrl(chequeTrue))
                    this.dispatchAction('GET_CHEQUE_LIST', this.genUrl(chequeFasle))
                    this.dispatchAction('PAYMENT_GET_LIST_DATA', this.contractId.contract_id)
                  } else {
                    // console.log(1111);
                    this.fire('toast', {
                      status: 'connectError', text: response.data, //คำสั่งสำหรับเปิด toast error
                      callback: () => {
                      }
                    })
                  }
                })
                .catch((error) => {
                  this.fire('toast', {
                    status: 'connectError', text: error, //คำสั่งสำหรับเปิด toast error
                    callback: () => {
                    }
                  })
                })
            }
          }
        })
      },
      getChequeApprove: function () {
        this.$.payDate.open()
      },
      approveCheck: function (e) {
        let getData = this.chequeTrue.filter((item) => item.check === true)
        newArr = []
        getData.map((item) => {
          newArr.push({
            deliver_date: item.deliver_date + 'T00:00:00+07:00',
            pay_date: this.pay_date + 'T00:00:00+07:00'
          })
        })
        this.fire('toast', {
          status: 'openDialog',
          text: 'ต้องการยืนยันเช็คใช่หรือไม่ ?',
          confirmed: (result) => {
            if (result == true) {
              this.dispatchAction('PUT_APPROVE_CHEQUE_LIST', newArr)
                .then((res) => {
                  this.fire('toast', {
                    status: 'success', text: 'ยืนยันแล้ว',  // คำสั่งสำหรับเปิด toast success
                    callback: () => {
                    }
                  })
                  this.$.payDate.close()
                  let chequeTrue = { id: this.contractId.contract_id, status: true }
                  let chequeFasle = { id: this.contractId.contract_id, status: false }
                  this.dispatchAction('GET_CHEQUE_LIST', this.genUrl(chequeTrue))
                  this.dispatchAction('GET_CHEQUE_LIST', this.genUrl(chequeFasle))
                  this.dispatchAction('PAYMENT_GET_LIST_DATA', this.contractId.contract_id)
                })
                .catch((error) => {
                  this.fire('toast', {
                    status: 'connectError', text: error, //คำสั่งสำหรับเปิด toast error
                    callback: () => {
                    }
                  })
                })
            }
          }
        })
      }

    });
  </script>
</dom-module>