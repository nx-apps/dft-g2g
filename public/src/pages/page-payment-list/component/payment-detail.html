<link rel="import" href="payment-detail-by-rice.html">
<link rel="import" href="./../../components/format-number-behavior.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel-body.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel-footer.html">
<link rel="import" href="./../../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="./../../../../bower_components/gl-grid/gl-grid-row.html">
<link rel="import" href="./../../../../bower_components/gl-grid/gl-grid-col.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-combo-box.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-input.html">
<link rel="import" href="./../../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="./../../components/g2g-logic-behavior.html">
<link rel="import" href="./../../components/validateFormBehaviors.html">
<link rel="import" href="./../../components/format-number-behavior.html">
<dom-module id="payment-detail">
  <style include="iron-flex iron-flex-factors iron-flex-alignment gl-styles page-style">
     :host {
      display: block;
    }

    .textheader-center {
      margin: 25px;
      text-align: center;
      font-size: var(--font-size-large);
    }

    table.gl-table-default {
      width: 98%;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }

    table.gl-table-default>thead.table-head>tr>th,
    table.gl-table-default>tbody.table-body>tr>td,
    table.gl-table-default>thead.table-head>tr>th {
      text-align: center;
    }

    table.gl-table-default>tbody.table-body>tr>td:nth-child(3) {
      text-align: left;
    }

    table.gl-table-default>tbody.table-body>tr>td:nth-child(1),
    table.gl-table-default>tbody.table-body>tr>td:nth-child(2) {
      width: 5%;
    }

    table.gl-table-default>tbody.table-body>tr>td:nth-child(3),
    table.gl-table-default>tbody.table-body>tr>td:nth-child(4) {
      width: 20%;
    }

    table.gl-table-default>tbody.table-body>tr>td:nth-child(5),
    table.gl-table-default>tfoot.table-foot>tr>td:nth-child(3) {
      text-align: right;
      width: 15%;
    }
  </style>
  <template>
    <gl-form-panel set-padding="10px 20px 10px 20px" set-border="1px">
      <gl-form-panel-body label="" set-padding="10px" set-border="1px">
        <div class="textheader-center">{{localize.text_payment_company}}</div>
      </gl-form-panel-body>

      <gl-form-panel-body label="" set-padding="10px" set-border="1px">
        <table class="gl-table-default">
          <thead class="table-head">
            <tr>
              <th>
                <paper-checkbox on-tap="_selectDataAll" checked="{{selectDataAll}}"></paper-checkbox>
                {{localize.text_check_box}}</th>
              <th>เลขที่เช็ค
                <!--{{localize.label_order}}-->
              </th>
              <th>จำนวนเงินที่ได้
                <!--{{localize.label_componey}}-->
              </th>
              <th>หักภาษี 1 %
                <!--{{localize.text_invoice_no}}-->
              </th>
              <th>จำนวนเงินที่จ่าย
                <!--{{localize.label_total_value_pay_full}}-->
              </th>
              <th>เลขที่ใบแจ้งนี้
                <!--{{localize.label_total_value_pay_tax}}-->
              </th>
              <th>เลขที่ใบหักภาษี ณ ที่จ่าย
                <!--{{localize.label_total_value_bath}}-->
              </th>
              <!--<th>-->
              <!--{{localize.label_total_value_bath}}-->
              <!--</th>-->
            </tr>
          </thead>
          <tbody class="table-body">
            <template is="dom-repeat" items="{{data}}">
              <tr>
                <td>
                  <paper-checkbox id="index" class="checkBoxPay" data="{{item}}" on-tap="checkData" on-click="setNoCheque" checked="{{item.check}}"></paper-checkbox>
                </td>
                <td>[[_ObcountIndex(index)]]</td>
                <td>[[formatNumber(item.value_bal_b)]]</td>
                <td>[[formatNumber(item.value_tax_b)]]</td>
                <td>[[formatNumber(item.value_final_b)]]</td>
                <td>[[item.invoice_company_no]]</td>
                <td>
                  [[changeString2Num(item.*,'pay_runing')]]
                  <gl-form-input type="number" class="required" required="{{item.check}}"  no-label-float value="{{item.pay_runing}}" data="[[item]]"
                    on-blur="checkDuplicatePayNo"></gl-form-input>
                     <!--on-blur="checkDuplicatePayNo"-->
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </gl-form-panel-body>
      <!--[[calValue(data.*)]]-->
      <gl-form-panel-body label="" set-padding="10px" set-border="1px">
        <br> {{localize.label_detail}}

        <gl-grid-row width="{{getWidth}}">
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
            <gl-combo-box class="required" required id="bank" label="ธนาคาร" item-label-path="bank_name_th" item-value-path="bank_id"
              items="[[dataBank]]" value="{{dataSet.bank_id}}" on-selected-item-changed="_getBankObject">
              <template>
                [[item.bank_name_th]]
              </template>
            </gl-combo-box>
          </gl-grid-col>
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
            <gl-form-input class="required" required label="{{localize.label_bank_branch}} :" placeholder="{{localize.label_bank_branch}}"
              value="{{dataSet.bank_branch}}"></gl-form-input>
          </gl-grid-col>
        </gl-grid-row>
        <gl-grid-row>
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
            <gl-form-input type="date" class="required" required label="{{localize.label_cheque_date_approve}}" value="{{dataSet.paid_date}}"></gl-form-input>
          </gl-grid-col>
          <!--<gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
            <gl-form-input class="required" required label="{{localize.text_amount}} :" placeholder="{{localize.text_amount}}" readonly
              value="{{formatNumber(dataSet.pay_value_b)}}"></gl-form-input>
          </gl-grid-col>-->
        </gl-grid-row>
        <gl-grid-row>
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,2]]"></gl-grid-col>
          <gl-grid-col width="[[getWidth]]" grid="[[300,12],[500,4]]">
            <br>
            <paper-checkbox class="checkBox" on-tap="toggle" aria-labelledby="label3"></paper-checkbox>
            <!--<label id="label3">-->
            {{localize.label_rice_from_stock}}
            <!--</label>-->
          </gl-grid-col>
        </gl-grid-row>

        <iron-collapse id="collapse">
          <payment-detail-by-rice data-fake="[[dataSilo]]"></payment-detail-by-rice>
        </iron-collapse>
      </gl-form-panel-body>

      <gl-form-panel-footer label="" set-padding="10px">
        <paper-button class="gl-btn-success" raised on-tap="addPayment">{{localize.btn_pay}}</paper-button>
      </gl-form-panel-footer>
    </gl-form-panel>

  </template>
  <script>
    Polymer({
      is: "payment-detail",
      behaviors: [
        ReduxBehavior,
        nylonBehavior,
        g2gLogicBehavior, FormatNumberBehavior, ValidateFormBehavior
      ],
      properties: {
        localize: {
          statePath: 'i18n.g2g'
        },
        data: {
          statePath: 'payment.paymentDetail',
          // type: Object,
          // value: {},
          // observer: '_setCheckBox'
        },
        no: {
          statePath: 'payment.payRunning',
          // type: Object,
          // value: {
          //   pay_runing:1
          // }
        },
        dataSet: {
          statePath: 'payment.dataSetPayment',
          // type: Object,
          // value:{
          //   pay_value_b:0
          // }
        },
        dataBank: {
          statePath: 'commonG2g.bankList',
        },
        contractId: {
          statePath: 'commonState.contractId',
          // observer: 'get'
        },
      },
      toggle: function () {
        this.$.collapse.toggle();
      },
      // // observers:[
      // //   '_oBCheckBoxDisabled(data.payment_detail.*)'
      // // ],
      // _setCheckBox(data) {
      //   try {
      //     return data.payment_detail.map((CheckBox) => CheckBox.status = false)
      //   } catch (e) {
      //     // console.log(e);
      //   }

      // },

      checkData: function (e) {
        // console.log(this.data.payment_detail);
        let dataPay = this.data.filter((item) => item.status == true)
        this.set('dataSet.pay_value_b', 0);
        this.set('dataSet.pay_value_b', Object.keys(dataPay).reduce((previous, current) => previous + dataPay[current].value_final_b, 0));
        //ปิดการไม่ให้เลือกอันอื่นที่ไม่ตรงกับเลือกอันแรก
        // this._checkBoxDisabled(e.currentTarget.exporterId);
        // this._checkBoxEabled(dataPay);
      },
      _getBankObject(e) {
        this.set('dataSet.bank', e.detail.value);
      },
      _selectDataAll: function (val) {
        try {
          if (this.selectDataAll) {
            this.data.map((item, index) => {
              // console.log(111);
              // console.log(item.pay_status === false);
              // if (item.pay_status === false) {
              if (item.pay_status === false && item.check === false) {
                this.set('data.' + index + '.check', true)
                let newCh = this.data.filter((items) => items.check === true && items.pay_status === false)
                let result = this.maxNumberInArrayObject(newCh, 'pay_runing')
                // console.log(result);
                if (result === 0) {
                  this.set('data.' + index + '.pay_runing', this.no.pay_runing)
                } else {
                  this.set('data.' + index + '.pay_runing', result + 1)
                }
              }
            })
          } else {
            this.data.map((item, index) => {

              if (item.pay_status === false) {
                this.set('data.' + index + '.check', true);
                this.set('data.' + index + '.check', false)
                this.set('data.' + index + '.pay_runing', '');
              }
            })
          }

        } catch (error) {

        }
      },
      setNoCheque: function (para) {
        // console.log(para.model.__data__)
        //เพิ่ม index ลงไปเพื่อไว้ ใส่ค่ากลับได้ถูกตำแหน่ง
        this.data.map((item, index) => item.indexItem = index)
        let item = para.model.__data__
        // หา item ที่ check แล่วและ pay_status ยังเป็น false
        let newCh = this.data.filter((item) => item.check === true && item.pay_status === false)
        newCh.sort((a, b) => Number(a.pay_runing) - Number(b.pay_runing))
        if (item.item.check === false) {
          this.set('data.' + item.index + '.pay_runing', '')
          let resultMin = this.minNumberInArrayObject(newCh, 'pay_runing')
          if (this.no.pay_runing === resultMin - 1) {
            newCh.map((item, index) => {
              if (item.pay_runing !== resultMin) {
                this.set('data.' + item.indexItem + '.pay_runing', resultMin)
              }
              ++resultMin
            })
          } else {
            let no = this.no.pay_runing
            // เรียงจากนค่า pay_runing น้อยไปหามาก
            newCh.map((item, index) => {
              this.set('data.' + item.indexItem + '.pay_runing', ++no)
            })
          }
        } else {

          //อยู่ใน g2gLogicBehavior 
          let result = this.maxNumberInArrayObject(newCh, 'pay_runing')
          if (result === 0)
            return this.set('data.' + item.index + '.pay_runing', this.no.pay_runing)
          return this.set('data.' + item.index + '.pay_runing', result + 1)
        }

      },
      // _checkBoxDisabled: function (exporter_id) {
      //   let notCheck = Polymer.dom(this.root).querySelectorAll('paper-checkbox.checkBoxPay')
      //   notCheck.map((el) => {
      //     if (exporter_id != el.exporterId) {
      //       el.disabled = true;
      //       el.parentNode.parentNode.style.backgroundColor = '#F1F1F1';
      //     }
      //   })
      // },
      // _checkBoxEabled: function (dataPay) {
      //   if (dataPay.length < 1) {
      //     let checkDisabled = Polymer.dom(this.root).querySelectorAll('paper-checkbox.checkBoxPay[aria-disabled="true"]');
      //     checkDisabled.map((el) => {
      //       el.disabled = false;
      //       el.parentNode.parentNode.style.backgroundColor = '#FFFFFF';
      //     })
      //   }
      // },
      _resiveDataPayment: function () {
        return new Promise((res, rej) => {
          let newData = JSON.parse(JSON.stringify(this.data.filter((item) => item.check == true)))
          let dataForSend = []
          newData.map((item) => {
            dataForSend.push({
              pay_runing: item.pay_runing,
              bank: this.dataSet.bank,
              bank_branch: this.dataSet.bank_branch,
              bank_id: this.dataSet.bank_id,
              paid_date: this.dataSet.paid_date + 'T00:00:00+07:00',
              pay_status: this.dataSet.pay_status,
              pay_value_b: item.value_final_b
            })
          })
          // console.log(dataForSend);
          res(dataForSend)
        })
      },
      _resiveFormPayment: function () {
        return new Promise((res, rej) => {
          if (this.validateForm('.required')) {
            this._resiveDataPayment().then((data) => {
              res(data)
            })
          } else {
            this.fire('toast', {
              status: 'connectError', text: 'กรุณากรอกข้อมูลให้ครบทุกช่อง', //คำสั่งสำหรับเปิด toast error
              callback: function () {
                rej('error')
              }
            })
          }
        })
      },
      addPayment: function () {
        // console.log(this.data);
        this.fire('toast', {
          status: 'openDialog',
          text: 'ต้องการชำระเงินใช่หรือไม่ ?',
          confirmed: (result) => {
            if (result == true) {
              this._resiveFormPayment()
                .then((res) => {
                  console.log(res);
                })
                .catch((error) => {
                  console.log(error);
                })
            }
          }
        })

        //   // / console.log(result, data);
        //   this.set('data.tags', []);
        //   // if (payDetId.status) {
        //   this.push('data.tags', this.data.payment_detail[0].contract_id,
        //     this.data.payment_detail[0].invoice_id,
        //     this.data.payment_detail[0].cl_id,
        //     this.data.payment_detail[0].book_id,
        //     this.dataForSelect.buyer_id);
        //   this._cleanDataPayment(this.data, (data) => {
        //     // console.log(data);
        //     this.fire('toast', {  //คำสั่งสำหรับเปิด toast dialog
        //       status: 'dialog',
        //       text: 'ต้องการจ่ายใช่หรือไม่ ?',
        //       confirmed: (result) => {
        //         if (result) {
        //           // /
        //           // this._cleanDataPayment(this.data, (data) => {
        //           // console.log(data);
        //           let contract_id = this._getUrl();


        //           this.insertCall('./g2g/payment/insert', data, () => {
        //             this.fire('toast', {
        //               status: 'success', text: 'บันทึกสำเร็จ',  // คำสั่งสำหรับเปิด toast success
        //               callback: () => {
        //                 //
        //                 this.fire('get-payment-list', { detail: contract_id });
        //                 this.fire('get-history-payment-list', { detail: contract_id });
        //                 // _getHistoryList
        //                 let el = Polymer.dom(this.root).querySelectorAll('.required');
        //                 el.map((el) => { el.reset(); });
        //               }
        //             });
        //           }, (data) => {
        //             // console.log(data);
        //             window.open(window._config.reportServer+'/api/payment/report6/' + data.id[0], '_blank');
        //             this.fire('close-drawer', { detail: 'close-drawer' });
        //             // console.log('data=>', data.id[0]);
        //             let checkDisabled = Polymer.dom(this.root).querySelectorAll('paper-checkbox.checkBoxPay[aria-disabled="true"]');
        //             checkDisabled.map((el) => {
        //               el.disabled = false;
        //               el.parentNode.parentNode.style.backgroundColor = '#FFFFFF';
        //             })
        //           });
        //           // });
        //         }

        //       }, //function ที่ใช้รับค่า ปุ่ม
        //       el: this, // compontents
        //       data: this.data // ข้อมูลที่ส่งไป เช่น id ที่จะใช้ลบข้อมูล ใน db
        //     })
        //   })




      },
      // _cleanDataPayment: function (data, callback) {
      //   let el = Polymer.dom(this.root).querySelectorAll('.required');
      //   let stat = el.map((el) => el.validate());
      //   if (stat.every(elem => elem == true)) {
      //     let { bank_branch, bank_id, exporter_id, fee_id, pay_value_b, pay_date, pay_runing, pay_times,pay_full,pay_tax } = data;
      //     let newData = { bank_branch, bank_id, exporter_id, fee_id, pay_value_b, pay_date, pay_runing, pay_times,pay_full,pay_tax  };
      //     newData.payment_detail = new Array();
      //     data.payment_detail.map((payDetId) => {
      //       if (payDetId.status) {
      //         newData.exporter_id = payDetId.exporter_id;
      //         newData.fee_id = payDetId.fee_id;
      //         newData.payment_detail.push({
      //           pay_det_id: payDetId.pay_det_id,
      //           // status:payDetId.status
      //         });
      //       }
      //     });
      //     newData.pay_date = new Date(newData.pay_date+'T00:00:00+07:00').toISOString();
      //     if (typeof data.tags !== 'undefined') {
      //       newData.tags = new Array();
      //       data.tags.map((tag) => {
      //         newData.tags.push(tag);
      //       });
      //     }
      //     callback(newData)
      //   }
      //   //
      // }
    });
  </script>
</dom-module>