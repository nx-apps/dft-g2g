<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel-body.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-input.html">
<link rel="import" href="./../../components/g2g-logic-behavior.html">

<dom-module id="fee-exports-invoice">
  <style is="custom-style" include="iron-flex iron-flex-alignment">
    .flexchild-1 {
      @apply(--layout-flex);
    }    
    .flexchild-2 {
      @apply(--layout-flex-2);
    }    
    .flexchild-5 {
      @apply(--layout-flex-5);
    }    
    .flex-center-justified {
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
    }    
    .header {
      text-align: center;
    }    
    .text {
      margin-top: 10px;
      margin-right: 10px;
    }    
    .setText {
      font-weight: bold;
      font-size: 18px;
      color: #737373;
    }    
    .inputHeader {
      width: 40%;
    }    
    .container {
      padding: 10px;
    }    
    table.default {
      border-collapse: collapse;
      width: 100%
    }    
    table.default,
    th,
    td {
      border-bottom: 1px solid #ddd;
    }    
    th,
    td {
      padding: 7px;
    }    
    th {
      text-align: center;
      background-color: #F1F1F1;
      white-space: nowrap;
    }    
    td {
      text-align: left;
      white-space: nowrap;
    }    
    tr:hover {
      background-color: #F1F1F1;
    }    
    gl-form-input.number {
      --paper-input-container-input: {
        text-align: right;
      }
    }
  </style>
  <template>
    <gl-form-panel>
      <gl-form-panel-body set-padding="5px" set-border="0px">
        <template is="dom-repeat" items="[[data]]" index-as="indexData">
          <div class="vertical layout">
            <div class="horizontal justified layout">
              <div>{{localize.invoice_no}} : [[item.invoice_no]]</div>
              <div>{{localize.cal_no}} : [[item.cl_no]]</div>
              <div>{{localize.fee_out}} : [[item.fee_ex_d]]</div> {{_calcfeeEx(feeEx, indexData)}}
              <div>{{localize.fee_in}} : [[item.fee_in_b]]</div> {{_calcfeeIn(feeIn, indexData)}}
              
              <div style="width:20px"></div>
              <div>[[_ObcountIndex(indexData)]]/[[invoicePage]]</div>
            </div>
            <div class="horizontal layout">
              <div>{{localize.ship_lot}} : [[item.ship_lot]]</div>
              <div style="margin-left:100px;">{{localize.vessel_name}} :
                [[_obArrayShip(item.ship)]]
              </div>
            </div>
          </div>
          <div style="overflow-x:auto;">
            <table class="default">
              <tr>
                <th>{{localize.exporter}}</th>
                <th>{{localize.amount}} ({{localize.ton}})<br>(1)</th>
                <th>{{localize.value_ton}} ({{localize.usd}})<br>(2)</th>
                <th>{{localize.amount}}{{localize.money}} ({{localize.usd}})<br>(3)= (1)*2</th>
                <th>{{localize.amount}}{{localize.money}} ({{localize.baht}})<br>(4)= (3)*[[rateBank]]</th>
                <th>{{localize.expenses_fee}} ({{localize.baht}})<br>(5)</th>
                <th>{{localize.balance}}{{localize.from}}{{localize.expenses_fee}}<br>(6)= (4)-(5)</th>
                <th>{{localize.expenses_one_present}} ({{localize.baht}})<br> (7)= (6)*1%</th>
                <th>{{localize.balance}} ({{localize.baht}})<br> (8)= (6)-(7)</th>
              </tr>
              <template is="dom-repeat" items="[[item.detail]]" as="item2">
                <tr>
                  <td><div style="margin-top: 15px;">[[item2.company.company_name_th]]</div></td>
                  <td>
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="[[item2.net_weight]]" disabled></gl-form-input>
                  </td>
                  <td>
                    <gl-form-input format-number="on" style="width:140px;text-align:center;" value="[[item2.price_d]]" disabled></gl-form-input>
                  </td>
                  <td>
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="[[item2.value_d]]" disabled></gl-form-input>
                  </td>
                  <td>[[_calcValueB(item2.value_d, rateBank, indexData, index)]]
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="{{item2.value_b}}"
                      disabled></gl-form-input>
                  </td>
                  <td>
                    [[changeString2Num(item2.*,'invoice_fee')]]
                    [[_calcValueFeeB(item.fee_ex_d, rateBank, item.fee_in_b, indexData, index)]]
                    <gl-form-input disabled style="text-align:right;" format-number="on" value="{{item2.value_fee_b}}"></gl-form-input>
                  </td>
                  <td>[[_calcValueBalB(item2.value_b, item2.value_fee_b, indexData, index)]]
                    <gl-form-input disabled style="text-align:right;" format-number="on" value="{{item2.value_bal_b}}"></gl-form-input>
                  </td>
                  <td>[[_calcValueTax(item2.value_bal_b, indexData, index)]]
                    <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="{{item2.value_tax_b}}"
                      disabled></gl-form-input>
                  </td>
                  <td>[[_calcValueFinalB(item2.value_bal_b, item2.value_tax_b, indexData, index)]]
                    <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="{{item2.value_final_b}}"
                      disabled></gl-form-input>
                  </td>
                </tr>
              </template>

              <tr>
                <td>{{localize.total}}</td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalTonInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <!--<gl-form-input format-number="on" style="width:140px;text-align:center;" value="[[_totalPricePerTonUsdInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>-->
                </td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalAmountUsdInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalBathInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="[[_totalFeeInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="[[_totalBalance(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="[[_totalIncomeTaxInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="[[_totalMoneyBathInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
              </tr>
            </table>
          </div>
        </template>
      </gl-form-panel-body>
    </gl-form-panel>
  </template>
  <script>
    Polymer({
      is: "fee-exports-invoice",
      properties: {
        localize:{
          statePath : 'i18n.fee'
        },
        data: {
          statePath : 'fee.list_calc'
        },
        totalInvoice: {
          type: Array,
          notify: true
        }
      },
      behaviors: [ReduxBehavior, g2gLogicBehavior],
      observers: [
        // '_oBcheckValue(data.invoice_detail.*)'
        // // '_changeDataPayrf(item.invoice_date)'
      ],
      // _oBcheckValue: function (data) {
      //   // console.log(data);
      // },
      // _changeDataPayrf: function (dateUn, index) {
      //   // this.getDateg2g(dateUn, (date) => {
      //   // console.log(date,index);
      //   // return date;
      //   // this.set('item.invoice_date', date);
      //   // console.log(this.item.invoice_date);
      //   // this.notifyPath('item.invoice_date');
      //   // });
      // },
      _calcfeeEx: function(fee, index){
        if(fee !== ''){
          var calc_fee_ex = parseInt(fee)/this.data.length;
          this.set('data.'+index+'.fee_ex_d', calc_fee_ex);
        }else{
          this.set('data.'+index+'.fee_ex_d', 0);
        }
      },
      _calcfeeIn: function(fee, index){
        if(fee !== ''){
          var calc_fee_in = parseInt(fee)/this.data.length;
          this.set('data.'+index+'.fee_in_b', calc_fee_in);
        }else{
          this.set('data.'+index+'.fee_in_b', 0);
        }
      },
      _countPage: function (invoiceIndex) {
        return invoiceIndex + 1;
      },
      _obArrayShip:function(ships){
        return ships.join()
      },
      _calcValueB: function (usd, rate_bank, indexData, index) {
        if(rate_bank !== ''){
          var calc_value_b = usd * parseFloat(rate_bank);
          this.set('data.'+indexData+'.detail.'+index+'.value_b',calc_value_b);
        }else{
          this.set('data.'+indexData+'.detail.'+index+'.value_b',0);
        }
      },
      _calcValueFeeB: function (fee_ex_d, rate_bank, fee_in_b, indexData, index) {
        if(rate_bank !== ''){
          var countDetail = this.data[indexData].detail.length;
          var calc_value_fee_b = ((parseFloat(fee_ex_d) * parseFloat(rate_bank)) + parseFloat(fee_in_b)) / countDetail;
          this.set('data.'+indexData+'.detail.'+index+'.value_fee_b', calc_value_fee_b);
        }else{
          this.set('data.'+indexData+'.detail.'+index+'.value_fee_b', 0);
        }
      },
      _calcValueBalB: function (value_b, value_fee_b, indexData, index) {
        var calc_value_bal_b = parseFloat(value_b) - parseFloat(value_fee_b);
        this.set('data.'+indexData+'.detail.'+index+'.value_bal_b', calc_value_bal_b);
      },
      _calcValueTax: function(value_bal_b, indexData, index){
        var calc_value_tax_b = (parseFloat(value_bal_b) * 1) / 100;
        this.set('data.'+indexData+'.detail.'+index+'.value_tax_b', calc_value_tax_b);
      },
      _calcValueFinalB: function (value_bal_b, value_tax_b, indexData, index) {
        var calc_value_final_b = parseFloat(value_bal_b) - parseFloat(value_tax_b);
        this.set('data.'+indexData+'.detail.'+index+'.value_final_b', calc_value_final_b);
      },

      _totalTonInvoices: function (index, data) {
        var result = 0;
        // console.log( index, data.base);
        if(typeof data.base[index] !== 'undefined'){
          data.base[index].detail.map((item) => {
              result += item.net_weight;
          })
          return result
        }
      },
      _totalAmountUsdInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base[index] !== 'undefined'){
          data.base[index].detail.map((item) => {
              result += item.value_d;
          })
          return result;
        }
      },
      _totalBathInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base[index] !== 'undefined'){
          data.base[index].detail.map((item) => {
              result += item.value_b;
          })
          return result;
        }

        if (isNaN(result)) {
          return '0'
        } else {
          this.set('data.totalBathInvoices', result);
          return result;
        }
      },
      _totalFeeInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base[index] !== 'undefined'){
          data.base[index].detail.map((item) => {
              result += item.value_fee_b;
          })
          return result;
        }

        if (isNaN(result)) {
          return '0'
        } else {
          this.set('data.totalFeeInvoices', result)
          return result;
        }
      },
      _totalBalance: function (index, data) {
        var result = 0;
        if(typeof data.base[index] !== 'undefined'){
          data.base[index].detail.map((item) => {
              result += item.value_bal_b;
          })
          return result;
        }

        if (isNaN(result)) {
          return '0'
        } else {
          this.set('data.totalBalance', result)
          return result;
        }
      },
      _totalIncomeTaxInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base[index] !== 'undefined'){
          data.base[index].detail.map((item) => {
              result += item.value_tax_b;
          })
          return result;
        }

        this.set('data.totalIncomeTaxInvoices', result);

        if (isNaN(result)) {
          return '0'
        } else {
          return result;
        }
      },
      _totalMoneyBathInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base[index] !== 'undefined'){
          data.base[index].detail.map((item) => {
              result += item.value_final_b;
          })
          return result;
        }

        if (isNaN(result)) {
          return '0'
        } else {
          this.set('data.totalMoneyBathInvoices', result);
          return result;
        }
      }
      // _totalPricePerTonUsdInvoices: function (index, data) {
      //   var result = 0;
      //   if(typeof data.base[index] !== 'undefined'){
      //     data.base[index].detail.map((item) => {
      //         result += item.price_d;
      //     })
      //     return result;
      //   }
      // },
    });
  </script>
</dom-module>