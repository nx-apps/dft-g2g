<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel-body.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-input.html">
<link rel="import" href="./../../components/g2g-logic-behavior.html">
<link rel="import" href="./../../components/validateFormBehaviors.html">

<dom-module id="fee-exports-invoice">
  <style is="custom-style" include="iron-flex iron-flex-alignment gl-styles page-style">
    .flexchild-1 {
      @apply(--layout-flex);
    }    
    .flexchild-2 {
      @apply(--layout-flex-2);
    }    
    .flexchild-5 {
      @apply(--layout-flex-5);
    }    
    .flex-center-justified {
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
    }    
    .header {
      text-align: center;
    }    
    .text {
      margin-top: 10px;
      margin-right: 10px;
    }    
    .setText {
      font-weight: bold;
      font-size: 18px;
      color: #737373;
    }    
    .inputHeader {
      width: 40%;
    }    
    .container {
      padding: 10px;
    }    
    table.default {
      border-collapse: collapse;
      width: 100%
    }    
    table.default,
    th,
    td {
      border-bottom: 1px solid #ddd;
    }    
    th,
    td {
      padding: 7px;
    }    
    th {
      text-align: center;
      background-color: #F1F1F1;
      white-space: nowrap;
    }    
    td {
      text-align: left;
      white-space: nowrap;
    }    
    tr:hover {
      background-color: #F1F1F1;
    }    
    gl-form-input.number {
      --paper-input-container-input: {
        text-align: right;
      }
    }
  </style>
  <template>
    <gl-form-panel>
      <gl-form-panel-body set-padding="5px" set-border="0px">
        <template is="dom-repeat" items="{{data.book}}" index-as="indexData">
          <div class="vertical layout">
            <div class="horizontal justified layout">
              <div>{{localize.invoice_no}} : [[item.invoice_no]]</div>
              <div>{{localize.cal_no}} : [[item.cl_no]]</div>
              <div>{{localize.ship_lot}} : [[item.ship_lot]]</div>
              <div>{{localize.vessel_name}} : [[_obArrayShip(item.ship)]]</div>
              <div style="width:20px"></div>
              <div>[[_ObcountIndex(indexData)]]/[[invoicePage]]</div>
            </div>
            <div class="horizontal layout">
              {{_calcfeeEx(feeEx, indexData)}}
              <gl-form-input label="{{localize.fee_out}}" class="number required" required format-number="on" style="width:200px;" value="{{item.fee_ex_d}}" disabled="[[common.btnDisabled]]"></gl-form-input>
              [[_calcFeeExChange(item.fee_ex_d, indexData)]]

              {{_calcfeeIn(feeIn, indexData)}}
              <gl-form-input label="{{localize.fee_in}}" class="number required" required format-number="on" style="width:200px; margin-left:50px;" value="{{item.fee_in_b}}" disabled="[[common.btnDisabled]]"></gl-form-input>
              [[_calcFeeInChange(item.fee_in_b, indexData)]]
              <!--<div>{{localize.fee_out}} : [[item.fee_ex_d]]</div> 
              <div>{{localize.fee_in}} : [[item.fee_in_b]]</div> -->
            </div>
          </div>
          <div style="overflow-x:auto;">
            <table class="default">
              <tr>
                <th>{{localize.exporter}}</th>
                <th>{{localize.amount}} ({{localize.ton}})<br>(1)</th>
                <th>{{localize.value_ton}} ({{localize.usd}})<br>(2)</th>
                <th>{{localize.amount}}{{localize.money}} ({{localize.usd}})<br>(3)= (1)*2</th>
                <th>{{localize.amount}}{{localize.money}} ({{localize.baht}})<br>(4)= (3)*[[rateBank]]</th>
                <th>{{localize.expenses_fee}} ({{localize.baht}})<br>(5)</th>
                <th>{{localize.balance}}{{localize.from}}{{localize.expenses_fee}}<br>(6)= (4)-(5)</th>
                <th>{{localize.expenses_one_present}} ({{localize.baht}})<br> (7)= (6)*1%</th>
                <th>{{localize.balance}} ({{localize.baht}})<br> (8)= (6)-(7)</th>
              </tr>
              <template is="dom-repeat" items="{{item.detail}}" as="item2">
                <tr>
                  <td><div style="margin-top: 15px;">[[item2.company.company_name_th]]</div></td>
                  <td>
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="[[item2.net_weight]]" disabled></gl-form-input>
                  </td>
                  <td>
                    <gl-form-input format-number="on" style="width:140px;text-align:center;" value="[[item2.price_d]]" disabled></gl-form-input>
                  </td>
                  <td>
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="[[item2.value_d]]" disabled></gl-form-input>
                  </td>
                  <td>[[_calcValueB(item2.value_d, rateBank, indexData, index)]]
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="{{item2.value_b}}"
                      disabled></gl-form-input>
                  </td>
                  <td>
                    [[changeString2Num(item2.*,'value_fee_b')]]
                    [[_calcValueFeeB(item.fee_ex_d, rateBank, item.fee_in_b, indexData, index)]]
                    <gl-form-input class="riceRequired" required style="text-align:right;" format-number="on" value="{{item2.value_fee_b}}" disabled="[[common.inputRice]]"></gl-form-input>
                  </td>
                  [[changeString2Num(item2.*,'value_bal_b')]]
                  <td>[[_calcValueBalB(item2.value_b, item2.value_fee_b, indexData, index)]]
                    <gl-form-input style="text-align:right;" format-number="on" value="{{item2.value_bal_b}}" disabled></gl-form-input>
                  </td>
                  <td>[[_calcValueTax(item2.value_bal_b, indexData, index)]]
                    <gl-form-input class="riceRequired" required style="text-align:right;" format-number="on" style="width:140px;" value="{{item2.value_tax_b}}"
                      disabled="[[common.inputRice]]"></gl-form-input>
                  </td>
                  [[changeString2Num(item2.*,'value_tax_b')]]
                  <td>[[_calcValueFinalB(item2.value_bal_b, item2.value_tax_b, indexData, index)]]
                    <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="{{item2.value_final_b}}"
                      disabled></gl-form-input>
                  </td>
                </tr>
              </template>

              <tr>
                <td>{{localize.total}}</td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalTonInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <!--<gl-form-input format-number="on" style="width:140px;text-align:center;" value="[[_totalPricePerTonUsdInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>-->
                </td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalAmountUsdInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalBathInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="{{_totalFeeInvoices(indexData,data.*)}}"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="[[_totalBalance(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="[[_totalIncomeTaxInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input style="text-align:right;" format-number="on" style="width:140px;" value="[[_totalMoneyBathInvoices(indexData,data.*)]]"
                    disabled></gl-form-input>
                </td>
              </tr>
            </table>
          </div>
        </template>
      </gl-form-panel-body>
    </gl-form-panel>

    <gl-form-panel>
      <fee-exports-sum total-invoice="{{data.book}}"></fee-exports-sum>
    </gl-form-panel>

    <div class="horizontal end-justified layout">
      
      <template is="dom-if" if="[[!common.btnDisabled]]">
        <paper-button raised class="gl-btn-default" on-tap="cancelFee" hidden="[[!common.isInsert]]">{{localize.reset_data}}</paper-button>
        <paper-button raised on-tap="addPayment" class="gl-btn-success" hidden="[[!common.isInsert]]">{{localize.add}}</paper-button>
      </template>

      <template is="dom-if" if="[[common.btnDisabled]]">
        <template is="dom-if" if="[[!data.fin_status]]">
          <template is="dom-if" if="[[!data.rice_status]]">
            <paper-button class="gl-btn-success" raised on-tap="approvePayment">{{localize.confirm}}</paper-button>
          </template>
        </template>
        
        <template is="dom-if" if="[[data.fin_status]]">
          <template is="dom-if" if="[[data.rice_status]]">
            <paper-button class="gl-btn-default" raised on-tap="rejectFee">{{localize.cancel}}</paper-button>
            <paper-button class="gl-btn-success" raised on-tap="approveFee">{{localize.confirm}}</paper-button>
          </template>
        </template>
      </template>
      
      <template is="dom-if" if="[[!common.btnDisabled]]">
        <template is="dom-if" if="[[!data.fin_status]]">
          <template is="dom-if" if="[[!data.rice_status]]">
            <paper-button raised class="gl-btn-default" on-tap="cancelContract" hidden="[[common.isInsert]]">{{localize.reset_data}}</paper-button>
            <paper-button raised class="gl-btn-default" on-tap="cancel" hidden="[[common.isInsert]]">{{localize.cancel}}</paper-button>
            <paper-button raised class="gl-btn-success" on-tap="savePayment" hidden="[[common.isInsert]]">{{localize.save}}</paper-button>
          </template>
        </template>
      </template>

      <template is="dom-if" if="[[common.inputRice]]">
        <template is="dom-if" if="[[data.fin_status]]">
          <template is="dom-if" if="[[!data.rice_status]]">
            <paper-button class="gl-btn-success" raised on-tap="riceApprove">{{localize.confirm}}</paper-button>
          </template>
        </template>
      </template>

      <template is="dom-if" if="[[!common.inputRice]]">
        <template is="dom-if" if="[[data.fin_status]]">
          <template is="dom-if" if="[[!data.rice_status]]">
            <paper-button raised class="gl-btn-default" on-tap="cancelContract" hidden="[[!common.isInsert]]">{{localize.reset_data}}</paper-button>
            <paper-button raised class="gl-btn-default" on-tap="cancel" hidden="[[!common.isInsert]]">{{localize.cancel}}</paper-button>
            <paper-button class="gl-btn-success" raised on-tap="riceSave">{{localize.save}}</paper-button>
          </template>
        </template>
      </template>

      <!--<template is="dom-if" if="[[data.fin_status]]">
        <template is="dom-if" if="[[common.btnDisabled]]">
          <paper-button raised class="gl-btn-danger" on-tap="editFee" hidden="[[common.isInsert]]">{{localize.cancel}}{{localize.confirm}}</paper-button>
        </template>
      </template>-->
    </div>

  </template>
  <script>
    Polymer({
      is: "fee-exports-invoice",
      properties: {
        localize:{
          statePath : 'i18n.fee'
        },
        data: {
          statePath : 'fee.list_calc'
        },
        totalInvoice: {
          type: Array,
          notify: true
        },
        common:{
          statePath : 'commonState.setState'
        }
      },
      behaviors: [ReduxBehavior, g2gLogicBehavior, ValidateFormBehavior],
      _calcfeeEx: function(fee, index){
        if(typeof this.data.book !== 'undefined'){
          if(fee !== ''){
            var calc_fee_ex = parseFloat(fee)/this.data.book.length;
            this.set('data.book.'+index+'.fee_ex_d', calc_fee_ex);
          }else{
            this.set('data.book.'+index+'.fee_ex_d', 0);
          }
        }
      },
      _calcFeeExChange:function(fee, index){
        // console.log(fee, index);
        var changeFee =parseFloat(fee);
        this.set('data.book.'+index+'.fee_ex_d', changeFee);
      },
      _calcfeeIn: function(fee, index){
        if(typeof this.data.book !== 'undefined'){
          if(fee !== ''){
            var calc_fee_in = parseFloat(fee)/this.data.book.length;
            this.set('data.book.'+index+'.fee_in_b', calc_fee_in);
          }else{
            this.set('data.book.'+index+'.fee_in_b', 0);
          }
        }
      },
      _calcFeeInChange:function(fee, index){
        var changeFee =parseFloat(fee);
        this.set('data.book.'+index+'.fee_in_b', changeFee);
      },
      _obArrayShip:function(ships){
        return ships.join()
      },
      _calcValueB: function (usd, rate_bank, indexData, index) {
        if(rate_bank !== ''){
          var calc_value_b = usd * parseFloat(rate_bank);
          this.set('data.book.'+indexData+'.detail.'+index+'.value_b',calc_value_b);
        }else{
          this.set('data.book.'+indexData+'.detail.'+index+'.value_b',0);
        }
      },
      _calcValueFeeB: function (fee_ex_d, rate_bank, fee_in_b, indexData, index) {
        if(rate_bank !== ''){
          var countDetail = this.data.book[indexData].detail.length;
          var calc_value_fee_b = ((parseFloat(fee_ex_d) * parseFloat(rate_bank)) + parseFloat(fee_in_b)) / countDetail;
          this.set('data.book.'+indexData+'.detail.'+index+'.value_fee_b', calc_value_fee_b);
        }else{
          this.set('data.book.'+indexData+'.detail.'+index+'.value_fee_b', 0);
        }
      },
      _calcValueBalB: function (value_b, value_fee_b, indexData, index) {
        var calc_value_bal_b = parseFloat(value_b) - parseFloat(value_fee_b);
        this.set('data.book.'+indexData+'.detail.'+index+'.value_bal_b', calc_value_bal_b);
      },
      _calcValueTax: function(value_bal_b, indexData, index){
        var calc_value_tax_b = (parseFloat(value_bal_b) * 1) / 100;
        this.set('data.book.'+indexData+'.detail.'+index+'.value_tax_b', calc_value_tax_b);
      },
      _calcValueFinalB: function (value_bal_b, value_tax_b, indexData, index) {
        var calc_value_final_b = parseFloat(value_bal_b) - numeral().unformat(value_tax_b);
        this.set('data.book.'+indexData+'.detail.'+index+'.value_final_b', calc_value_final_b);
      },
      _totalTonInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base.book[index] !== 'undefined'){
          data.base.book[index].detail.map((item) => {
              result += item.net_weight;
          })
          this.set('data.book.'+index+'.totalTonInvoices', result);
          return result
        }
      },
      _totalAmountUsdInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base.book[index] !== 'undefined'){
          data.base.book[index].detail.map((item) => {
              result += item.value_d;
          })
          this.set('data.book.'+index+'.totalAmountUsdInvoices', result);
          return result;
        }
      },
      _totalBathInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base.book[index] !== 'undefined'){
          data.base.book[index].detail.map((item) => {
              result += parseFloat(item.value_b);
          })
          // this.set('data.'+index+'.totalBathInvoices', result);
          this.set('data.book.'+index+'.value_b', result);
          return result;
        }
      },
      _totalFeeInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base.book[index] !== 'undefined'){
          data.base.book[index].detail.map((item) => {
              result += parseFloat(item.value_fee_b);
          })
          // this.set('data.'+index+'.totalFeeInvoices', result);
          this.set('data.book.'+index+'.value_fee_b', result);
          return result;
        }
      },
      _totalBalance: function (index, data) {
        var result = 0;
        if(typeof data.base.book[index] !== 'undefined'){
          data.base.book[index].detail.map((item) => {
              result += parseFloat(item.value_bal_b);
          })
          // this.set('data.'+index+'.totalBalance', result);
          this.set('data.book.'+index+'.value_bal_b', result);
          return result;
        }
      },
      _totalIncomeTaxInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base.book[index] !== 'undefined'){
          data.base.book[index].detail.map((item) => {
              result += parseFloat(item.value_tax_b);
          })
          // this.set('data.'+index+'.totalIncomeTaxInvoices', result);
          this.set('data.book.'+index+'.value_tax_b', result);
          return result;
        }
      },
      _totalMoneyBathInvoices: function (index, data) {
        var result = 0;
        if(typeof data.base.book[index] !== 'undefined'){
          data.base.book[index].detail.map((item) => {
              result += parseFloat(item.value_final_b);
          })
          // this.set('data.'+index+'.totalMoneyBathInvoices', result);
          this.set('data.book.'+index+'.value_final_b', result);
          return result;
        }
      },
      addPayment: function (){
        var check = this.validateForm('.required');
        let newData = {
          rate_bank_b : parseFloat(this.rateBank), 
          rate_tt_b : parseFloat(this.rateTt), 
          fee_date : this.data.fee_date+'T00:00:00+07:00', 
          book : this.data.book
        };
        newData.book.map((item) => {
          delete item.totalAmountUsdInvoices;
          delete item.totalTonInvoices;
        })
        // console.log(newData);
        this.fire('check-required');
        if(this.checkRequired === true && check === true){
          this.fire('toast', {
            status: 'openDialog', 
            text: 'ต้องการเพิ่มการคิดค่าธรรมเนียมใช่หรือไม่',
            confirmed: (result) =>{
              if(result === true){
                this.dispatchAction('FEE_INSERT', newData);
              }
            }
          });
        }else{
          this.fire('toast', {
            status: 'connectError', text: 'กรุณากรอกข้อมูลให้ครบถ้วน',callback: () => {}
          });
        }
      },
      cancelFee: function(){
        var book_id = this.data.book.map((item) => {
          return item.book_id
        });
        var id = book_id.join('_');
        this.dispatchAction('FEE_CALC_DATA', id);
      },
      savePayment:function(){
        let{rate_bank_b, rate_tt_b, fee_date, book, id} = this.data;
        let newData = {rate_bank_b, rate_tt_b, book, id};
        newData.fee_date = this.data.fee_date+'T00:00:00+07:00';
        // console.log(newData);
        this.fire('check-required');
        if(this.checkRequired === true){
          this.fire('toast', {
            status: 'openDialog', 
            text: 'ต้องการเพิ่มค่าธรรมเนียมใช่หรือไม่',
            confirmed: (result) =>{
              if(result === true){
                this.dispatchAction('FEE_UPDATE', newData);
              }
            }
          });
        }else{
          this.fire('toast', {
            status: 'connectError', text: 'กรุณากรอกข้อมูลให้ครบถ้วน',callback: () => {}
          });
        }
      },
      cancel:function(){
        this.dispatchAction('FEE_GET_ID_DATA',this.data.id);
        this.dispatchAction('SET_STATE',{
            isInsert: false,
            btnDisabled: true,
            inputRice: true
        });
      },
      cancelContract:function(){
        this.dispatchAction('FEE_GET_ID_DATA',this.data.id);
      },
      approvePayment:function(){
        var newData = {
          id: this.data.id,
          fin_status: true
        };
        this.fire('toast',{
          status: 'openDialog',
          text: 'ต้องการยืนยันการคิดค่าธรรมเนียมใช่หรือไม่',
          confirmed: (result) =>{
            if(result === true){
              this.dispatchAction('FEE_APPROVE', newData);
            }
          }
        })
      },
      riceSave:function(){
        var check = this.validateForm('.riceRequired');
        // console.log(this.data);
        if(check === true){
          this.fire('toast',{
            status: 'openDialog',
            text: 'ต้องการบันทึกการถัวเฉลี่ยค่าธรรมเนียมใช่หรือไม่',
            confirmed: (result) =>{
              if(result === true){
                let{rate_bank_b, rate_tt_b, fee_date, book, id} = this.data;
                let newData = {rate_bank_b, rate_tt_b, book, id};
                newData.fee_date = this.data.fee_date+'T00:00:00+07:00';
                this.dispatchAction('FEE_RICE_UPDATE', newData);
              }
            }
          })
        }else{
          this.fire('toast',{
            status:'connectError', text: 'กรุณากรอกข้อมูลให้ครบ',
            callback: () =>{}
          })
        }
      },
      riceApprove:function(){
        let newData = {
          id: this.data.id,
          rice_status: true
        }
        this.fire('toast',{
          status: 'openDialog',
          text: 'ต้องการยืนยันการถัวเฉลี่ยค่าธรรมเนียมใช่หรือไม่',
          confirmed: (result) =>{
            if(result === true){
              this.dispatchAction('FEE_RICE_APPROVE', newData);
            }
          }
        })
      },
      rejectFee:function(){
        let newData = {
          id: this.data.id,
          rice_status: false
        }
        this.fire('toast',{
          status: 'openDialog',
          text: 'ต้องการยกเลิกการถัวเฉลี่ยค่าธรรมเนียมใช่หรือไม่',
          confirmed: (result) =>{
            if(result === true){
              this.dispatchAction('FEE_REJECT', newData);
            }
          }
        })
      },
      approveFee:function(){
        let newData = {
          id: this.data.id,
          fee_status: true
        }
        this.fire('toast',{
          status: 'openDialog',
          text: 'ต้องการยืนยันการถัวเฉลี่ยค่าธรรมเนียมใช่หรือไม่',
          confirmed: (result) =>{
            if(result === true){
              this.dispatchAction('FEE_APPROVE_FINSH', newData);
            }
          }
        })
      }
    });
  </script>
</dom-module>