<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-panel-body.html">
<link rel="import" href="./../../../../bower_components/gl-form/gl-form-input.html">
<link rel="import" href="./../../components/g2g-logic-behavior.html">

<dom-module id="fee-exports-invoice">
  <style is="custom-style" include="iron-flex iron-flex-alignment">
    .flexchild-1 {
      @apply(--layout-flex);
    }    
    .flexchild-2 {
      @apply(--layout-flex-2);
    }    
    .flexchild-5 {
      @apply(--layout-flex-5);
    }    
    .flex-center-justified {
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
    }    
    .header {
      text-align: center;
    }    
    .text {
      margin-top: 10px;
      margin-right: 10px;
    }    
    .setText {
      font-weight: bold;
      font-size: 18px;
      color: #737373;
    }    
    .inputHeader {
      width: 40%;
    }    
    .container {
      padding: 10px;
    }    
    table.default {
      border-collapse: collapse;
      width: 100%
    }    
    table.default,
    th,
    td {
      border-bottom: 1px solid #ddd;
    }    
    th,
    td {
      padding: 7px;
    }    
    th {
      text-align: center;
      background-color: #F1F1F1;
      white-space: nowrap;
    }    
    td {
      text-align: left;
      white-space: nowrap;
    }    
    tr:hover {
      background-color: #F1F1F1;
    }    
    gl-form-input.number {
      --paper-input-container-input: {
        text-align: right;
      }
    }
  </style>
  <template>
    <gl-form-panel>
      <gl-form-panel-body set-padding="5px" set-border="0px">
        <template is="dom-repeat" items="[[data]]">
          <div class="horizontal justified layout">
            <div>{{localize.text_invoice_no}} : [[item.invoice_no]]</div>
            <div>{{localize.label_vessel}} :
              <template is="dom-repeat" items="[[data.ship]]">
                [[item.ship_name]] ,
              </template>
            </div>
            <div>{{localize.label_lot_no}} : [[data.ship_lot_no]]</div>
            <div style="width:20px"></div>
            <div>[[index]]/[[invoicePage]]</div>
          </div>
          <div style="overflow-x:auto;">
            <table class="default">
              <tr>
                <th>{{localize.text_exporter_name}}</th>
                <th>{{localize.label_total_value_ton}}<br>(1)</th>
                <th>{{localize.label_total_value_ton_per_usd}}<br>(2)</th>
                <th>{{localize.label_total_value_usd}}<br>(3)=(1)*2</th>
                <th>{{localize.label_total_value_bath}}<br>(4)=(3)*[[rateBank]]</th>
                <th>{{localize.label_expenses_fee}}<br>(5)</th>
                <th>{{localize.label_expenses_one_present}}<br> (6)=((4)-(5))*1%</th>
                <th>{{localize.label_total_bath}}<br> (7)=((4)-(5)-(6))</th>
              </tr>
              <template is="dom-repeat" items="[[item.detail]]" as="item2">
                <tr>
                  <td><div style="margin-top: 15px;">[[item2.company.company_name_th]]</div></td>
                  [[_totalQuantityTons(item2.net_weight,index)]]
                  <td>
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="[[item2.net_weight]]" disabled></gl-form-input>
                  </td>
                  [[_totalPricePerTon(item2.price_d,index)]]
                  <td>
                    <gl-form-input format-number="on" style="width:140px;text-align:center;" value="[[item2.price_d]]" disabled></gl-form-input>
                  </td>
                  [[_totalAmountUsd(item2.value_d,index)]]
                  <td>
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="[[item2.value_d]]" disabled></gl-form-input>
                  </td>
                  <td>
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalBath(item2.value_d, rateBank, index)]]"
                      disabled></gl-form-input>
                  </td>
                  <td>
                    [[changeString2Num(item2.*,'invoice_fee')]]
                    [[_totalfee(item2.invoice_fee,index)]]
                    <gl-form-input disabled class="number" format-number="on" value="{{item2.invoice_fee}}"></gl-form-input>
                  </td>
                  <td>
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_incomeTax(item2.net_weight,item2.price_d,rateBank,item2.invoice_fee,index)]]"
                      disabled></gl-form-input>
                  </td>
                  <td>
                    <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalMoneyInvoice(item2.net_weight,item2.price_d,rateBank,item2.invoice_fee,index)]]"
                      disabled></gl-form-input>
                  </td>
                </tr>
              </template>

              <tr>
                <td>{{localize.label_sum}}</td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalTonInvoices(index,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input format-number="on" style="width:140px;text-align:center;" value="[[_totalPricePerTonUsdInvoices(index,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalAmountUsdInvoices(index,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalBathInvoices(index,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalFeeInvoices(index,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalIncomeTaxInvoices(index,data.*)]]"
                    disabled></gl-form-input>
                </td>
                <td>
                  <gl-form-input class="number" format-number="on" style="width:140px;" value="[[_totalMoneyBathInvoices(index,data.*)]]"
                    disabled></gl-form-input>
                </td>
              </tr>
            </table>
          </div>
        </template>
      </gl-form-panel-body>
    </gl-form-panel>
  </template>
  <script>
    Polymer({
      is: "fee-exports-invoice",
      properties: {
        localize:{
          statePath : 'i18n.g2g'
        },
        data: {
          // type: Object,
          // notify: true
          statePath : 'fee.list_calc'
        },
        totalInvoice: {
          type: Array,
          notify: true
        }
      },
      behaviors: [ReduxBehavior, g2gLogicBehavior],
      observers: [
        '_averageFee(feeTotal,data)',
        // '_oBcheckValue(data.invoice_detail.*)'
        // // '_changeDataPayrf(item.invoice_date)'
      ],
      // _oBcheckValue: function (data) {
      //   // console.log(data);
      // },
      // _changeDataPayrf: function (dateUn, index) {
      //   // this.getDateg2g(dateUn, (date) => {
      //   // console.log(date,index);
      //   // return date;
      //   // this.set('item.invoice_date', date);
      //   // console.log(this.item.invoice_date);
      //   // this.notifyPath('item.invoice_date');
      //   // });
      // },
      _countPage: function (invoiceIndex) {
        return invoiceIndex + 1;
      },
      // // numeral().format('0,0.00')
      _totalQuantityTons: function (quantity_tons, index) {
        this.set('data.invoice_detail.' + index + '.quantity_tons', parseFloat(quantity_tons));
      },
      _totalPricePerTon: function (price_per_ton, index) {
        this.set('data.invoice_detail.' + index + '.price_per_ton', parseFloat(price_per_ton));
      },
      _totalBath: function (usd, rate_bank, index) {
        // console.log(usd, rate_bank, index);
        if(rate_bank.length === 0){
          return 0
        }else{
          var total = usd * parseFloat(rate_bank);
          return total
        }
      },
      _totalAmountUsd: function (amountUsd, index) {
        this.set('data.invoice_detail.' + index + '.amountUsd', parseFloat(amountUsd));
      },
      _averageFee: function (feeTotal, invoice) {
        try {
          if (!this.isInputDisabled) {
            var invoice_fee = invoice.length;
            for (var i = 0; i < invoice.length; i++) {
              for(var j = 0; j < invoice[i].detail.length; j++){
                this.set('data.' + i + '.detail.'+ j +'.invoice_fee', feeTotal / invoice_fee);
              }
            }
          }
        } catch (e) {
          // console.log(e);
        }
      },
      _totalfee: function (invoice_fee, index) {
        this.set('data.invoice_detail.' + index + '.invoice_fee', parseFloat(invoice_fee));
      },
      // // (6)=((4)-(5))*1%
      _incomeTax: function (quantity_tons, price_per_ton, rate_bank, invoice_fee, index) {
        var incomeTax = ((((parseFloat(quantity_tons) * parseFloat(price_per_ton)) * parseFloat(rate_bank)) - parseFloat(invoice_fee)) * 1) / 100;
        // console.log(this.toNumberFormat(incomeTax));
        // console.log(incomeTax);
        this.set('data.invoice_detail.' + index + '.incomeTax', incomeTax);
        return incomeTax;
      },
      // // (3)*34.96
      // // (7)=((4)-(5)-(6))<
      _totalMoneyInvoice: function (quantity_tons, price_per_ton, rate_bank, invoice_fee, index) {

        try {
          let incomeTax = ((((parseFloat(quantity_tons) * parseFloat(price_per_ton)) * parseFloat(rate_bank)) - parseFloat(invoice_fee)) * 1) / 100

          var moneyInvoice = ((parseFloat(quantity_tons) * parseFloat(price_per_ton)) * parseFloat(rate_bank) - parseFloat(invoice_fee)) - incomeTax
          this.set('data.invoice_detail.' + index + '.moneyInvoice', moneyInvoice);
          // console.log("moneyInvoice =>",this.data.invoice_detail[index].moneyInvoice);
          return moneyInvoice;
        } catch (e) {
          // console.log(e);
        }
      },
      _totalTonInvoices: function (index, data) {
        var result = 0;
        // console.log( index, data.base);
        data.base[index].detail.map((item) => {
            result += item.net_weight;
        })
        return result;
      },
      _totalPricePerTonUsdInvoices: function (index, data) {
        var result = 0;
        data.base[index].detail.map((item) => {
            result += item.price_d;
        })
        return result;
        // test.base.invoice_detail.map((item) => {
        //   result += item.price_d;
        // })
        // this.set('data.totalPricePerTonUsdInvoices', result);
        // return result;
      },
      _totalAmountUsdInvoices: function (index, data) {
        var result = 0;
        data.base[index].detail.map((item) => {
            result += item.value_d;
        })
        return result;
        // test.base.invoice_detail.map((item) => {
        //   result += item.amountUsd;
        // })
        // this.set('data.totalAmountUsdInvoices', result);
        // return result.toString();
      },
      _totalBathInvoices: function (index, data) {
        var result = 0;
        // test.base.invoice_detail.map((item) => {
        //   result += item.testza;
        // });

        if (isNaN(result)) {
          return '0'
        } else {
          this.set('data.totalBathInvoices', result);
          return result;
        }
      },
      _totalFeeInvoices: function (index, data) {
        var result = 0;
        // test.base.invoice_detail.map((item) => {
        //   result += item.invoice_fee;
        //   // console.log(result);
        // })
        if (isNaN(result)) {
          return '0'
        } else {
          this.set('data.totalFeeInvoices', result)
          return result;
        }
      },
      _totalIncomeTaxInvoices: function (index, data) {
        var result = 0;
        // test.base.invoice_detail.map((item) => {
        //   result += item.incomeTax;
        // });
        this.set('data.totalIncomeTaxInvoices', result);

        if (isNaN(result)) {
          return '0'
        } else {
          return result;
        }
      },
      _totalMoneyBathInvoices: function (index, data) {
        var result = 0;
        // test.base.invoice_detail.map((item) => {
        //   // console.log('item.moneyInvoice  =>',item.moneyInvoice);
        //   result += item.moneyInvoice;
        // })

        if (isNaN(result)) {
          return '0'
        } else {
          this.set('data.totalMoneyBathInvoices', result);
          return result;
        }
      },
    });
  </script>
</dom-module>